{% extends "app_base.html" %}

{% load i18n crispy_forms_tags %}

{% block title %}
  {% if object %}
    {% blocktrans with name=object.name %}Edit {{ name }}{% endblocktrans %}
  {% else %}
    {% trans "New project" %}
  {% endif %}
  · Validibot
{% endblock title %}

{% block left_sidebar %}
  {% include "app/partial/components/app_left_nav.html" %}
{% endblock left_sidebar %}

{% block app_content %}
  <div class="container-fluid" id="project-form">
    <div class="row">
      <div class="col-12 col-lg-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <h1 class="h5 mb-3">
              {% if object %}
                {% blocktrans with name=object.name %}Edit {{ name }}{% endblocktrans %}
              {% else %}
                {% trans "Create project" %}
              {% endif %}
            </h1>
            <form method="post" novalidate>
              {% csrf_token %}
              {{ form|crispy }}
              <div class="d-flex justify-content-end gap-2 mt-3">
                <a href="{% url 'projects:project-list' %}"
                   class="btn btn-outline-secondary">
                  {% trans "Cancel" %}
                </a>
                <button type="submit" class="btn btn-primary">
                  {% trans "Save" %}
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock app_content %}

{% block inline_javascript %}
  {{ block.super }}
  <script>
    window.addEventListener("DOMContentLoaded", () => {
      const input = document.querySelector('[data-testid="project-color-input"]');
      if (!input) {
        return;
      }
      const previewBtn = document.querySelector(
        `.project-color-preview-btn[data-color-input="${input.id}"]`,
      );

      const normalizeHex = (value) => {
        if (!value) {
          return null;
        }
        const trimmed = value.trim();
        const hexMatch = trimmed.match(/^#?([0-9a-fA-F]{6})$/);
        if (!hexMatch) {
          return null;
        }
        return `#${hexMatch[1].toUpperCase()}`;
      };

      const clamp = (value) => Math.min(255, Math.max(0, value));

      const lighten = (hex, factor = 0.25) => {
        const normalized = normalizeHex(hex);
        if (!normalized) {
          return null;
        }
        const r = parseInt(normalized.substring(1, 3), 16);
        const g = parseInt(normalized.substring(3, 5), 16);
        const b = parseInt(normalized.substring(5, 7), 16);
        const lightenChannel = (channel) => clamp(channel + (255 - channel) * factor);
        return `#${Math.round(lightenChannel(r)).toString(16).padStart(2, "0")}${Math.round(
          lightenChannel(g),
        )
          .toString(16)
          .padStart(2, "0")}${Math.round(lightenChannel(b))
          .toString(16)
          .padStart(2, "0")}`.toUpperCase();
      };

      const contrastColor = (hex) => {
        const normalized = normalizeHex(hex);
        if (!normalized) {
          return "#FFFFFF";
        }
        const r = parseInt(normalized.substring(1, 3), 16);
        const g = parseInt(normalized.substring(3, 5), 16);
        const b = parseInt(normalized.substring(5, 7), 16);
        const luminance = 0.2126 * r + 0.7152 * g + 0.0722 * b;
        return luminance > 140 ? "#1F2328" : "#FFFFFF";
      };

      const DEFAULT_COLOR =
        normalizeHex(input.value) ||
        normalizeHex(previewBtn?.dataset.initialColor) ||
        "#6C757D";

      const updateButtonStyles = (color) => {
        if (!previewBtn) {
          return;
        }
        const normalized = normalizeHex(color) || DEFAULT_COLOR;
        const borderColor = lighten(normalized, 0.35) || normalized;
        const iconColor = contrastColor(normalized);
        previewBtn.style.backgroundColor = normalized;
        previewBtn.style.borderColor = borderColor;
        previewBtn.style.color = iconColor;
        previewBtn.dataset.currentColor = normalized;
      };

      const updatePreview = () => {
        const normalized = normalizeHex(input.value);
        if (normalized) {
          input.value = normalized;
        }
        const displayColor = normalized || DEFAULT_COLOR;
        updateButtonStyles(displayColor);
        if (previewBtn) {
          previewBtn.setAttribute(
            "aria-label",
            `${displayColor} – ${previewBtn.dataset.labelText || "Generate a new color"}`,
          );
        }
      };

      const randomHex = () => {
        const value = Math.floor(Math.random() * 0xffffff)
          .toString(16)
          .toUpperCase()
          .padStart(6, "0");
        return `#${value}`;
      };

      input.addEventListener("input", updatePreview);

      if (previewBtn) {
        previewBtn.dataset.labelText = previewBtn.getAttribute("aria-label") || "Generate a new color";
        previewBtn.addEventListener("click", (event) => {
          event.preventDefault();
          const color = randomHex();
          input.value = color;
          input.dispatchEvent(new Event("input", {
            bubbles: true
          }));
        });
      }

      updatePreview();
    });
  </script>
{% endblock inline_javascript %}
