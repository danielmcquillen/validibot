{% load i18n core_tags %}

{% if not workflow.is_active %}
  <div class="alert alert-warning d-flex align-items-start gap-2"
       role="alert">
    <i class="bi-pause-circle-fill fs-4"></i>
    <div>
      <p class="mb-1 fw-semibold">
        {% trans "This workflow is currently inactive." %}
      </p>
      <p class="mb-1">
        {% trans "Re-enable the workflow from the settings page before launching new runs." %}
      </p>
      <a class="btn btn-sm btn-outline-primary mt-2"
         href="{% org_url 'workflows:workflow_detail' pk=workflow.pk %}">
        {% trans "Manage workflow" %}
      </a>
    </div>
  </div>
{% elif not has_steps %}
  <div class="alert alert-info d-flex align-items-start gap-2" role="alert">
    <i class="bi-diagram-3 fs-4"></i>
    <div>
      <p class="mb-1 fw-semibold">
        {% trans "This workflow has no steps yet." %}
      </p>
      <p class="mb-1">
        {% trans "Add at least one validation step before launching new runs." %}
      </p>
      <a class="btn btn-sm btn-outline-primary mt-2"
         href="{% org_url 'workflows:workflow_detail' pk=workflow.pk %}">
        {% trans "Manage workflow" %}
      </a>
    </div>
  </div>
{% elif not can_execute %}
  <div class="alert alert-warning d-flex align-items-center" role="alert">
    <i class="bi-exclamation-triangle-fill me-2"></i>
    <div>
      {% blocktrans %}
        You do not have permission to run this workflow. Contact an organization admin to request the Executor role.
      {% endblocktrans %}
    </div>
  </div>
  <p class="text-muted">
    {% trans "You can still review the workflow configuration from the Info tab." %}
  </p>
{% else %}
  <div class="row d-flex flex-row flex-grow-1 g-4 align-items-start">
    <div class="col-12 col-xl-7 d-flex flex-column flex-grow-1">

      <form method="post"
            action="{% org_url 'workflows:workflow_launch_start' pk=workflow.pk %}"
            enctype="multipart/form-data"
            class="card app-card submit-content-card"
            id="workflow-launch-form"
            hx-post="{% org_url 'workflows:workflow_launch_start' pk=workflow.pk %}"
            hx-target="#workflow-launch-panel"
            hx-swap="innerHTML"
            hx-indicator="#workflow-launch-submit-indicator">
        {% csrf_token %}

        {% comment %}
        <div class="card-header">
          <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3">
            <span class="fw-semibold">{% trans "Submit content" %}</span>
          </div>
        </div>
        {% endcomment %}

        <div class="card submit-content-card">
          <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs " role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active"
                        id="workflow-launch-content-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#workflow-launch-tab-pane"
                        type="button"
                        role="tab"
                        aria-controls="workflow-launch-tab-pane"
                        aria-selected="true">
                  {% trans "Submit content" %}
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link"
                        id="workflow-launch-meta-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#workflow-launch-meta-pane"
                        type="button"
                        role="tab"
                        aria-controls="workflow-launch-meta-pane"
                        aria-selected="false">
                  {% trans "Extra data" %}
                </button>
              </li>
            </ul>
          </div>

          <div class="card-body">

            {% if launch_form.non_field_errors %}
              <div class="alert alert-danger" role="alert">
                {% for error in launch_form.non_field_errors %}
                  <p class="mb-0">
                    {{ error }}
                  </p>
                {% endfor %}
              </div>
            {% endif %}

            <div class="tab-content">

              <div class="tab-pane show active"
                   id="workflow-launch-tab-pane"
                   role="tabpanel"
                   aria-labelledby="workflow-launch-content-tab">

                <div class="file-type-selection-wrapper">
                  <label class="fw-semibold">
                    {{ launch_form.file_type.label }}
                  </label>
                  {% if launch_form.single_file_type_label %}
                    <div class="form-control-plaintext">
                      {{ launch_form.single_file_type_label }}
                    </div>
                    {{ launch_form.file_type }}
                  {% else %}
                    {{ launch_form.file_type }}
                  {% endif %}
                  {{ launch_form.file_type.errors }}
                </div>

                <div class="workflow-input-mode mb-3 d-flex flex-column flex-lg-row align-items-lg-center gap-2">
                  <label class="fw-semibold">
                    {% trans "Input mode" %}
                  </label>
                  <div class="btn-group btn-group-sm"
                       role="group"
                       aria-label="{% trans 'Select input mode' %}">
                    <button class="btn btn-outline-primary active"
                            type="button"
                            data-content-mode="upload">
                      <i class="bi-cloud-upload me-1"></i>{% trans "Upload file" %}
                    </button>
                    <button class="btn btn-outline-primary"
                            type="button"
                            data-content-mode="paste">
                      <i class="bi-file-text me-1"></i>{% trans "Paste text" %}
                    </button>
                  </div>
                </div>

                <div class="workflow-drop-wrapper" data-upload-section>
                  <div class="workflow-dropzone"
                       data-dropzone
                       role="button"
                       tabindex="0"
                       aria-label="{% trans 'Upload file by browsing or dropping it here' %}">
                    <div class="workflow-dropzone__icon">
                      <i class="bi-cloud-arrow-up"></i>
                    </div>
                    <div class="workflow-dropzone__text">
                      <strong>{% trans "Drag & drop a file" %}</strong>
                      <span class="text-muted d-block">
                        {% trans "or click to browse" %}
                      </span>
                    </div>
                    <button type="button"
                            class="btn btn-secondary btn-sm mt-2"
                            data-dropzone-browse>
                      {% trans "Browse files" %}
                    </button>
                    <div class="workflow-dropzone__file text-muted small mt-2"
                         data-dropzone-file>
                      {% trans "No file selected yet." %}
                    </div>
                  </div>
                  {{ launch_form.attachment }}
                  {{ launch_form.attachment.errors }}
                </div>

                <div class="workflow-paste-wrapper mb-3 d-none" data-paste-section>
                  <label class="form-label fw-semibold"
                         for="{{ launch_form.payload.id_for_label }}">
                    {{ launch_form.payload.label }}
                  </label>
                  {{ launch_form.payload }}
                  {% if launch_form.payload.help_text %}
                    <div class="form-text">
                      {{ launch_form.payload.help_text }}
                    </div>
                  {% endif %}
                  {{ launch_form.payload.errors }}
                </div>
              </div>

              <div class="tab-pane"
                   id="workflow-launch-meta-pane"
                   role="tabpanel"
                   aria-labelledby="workflow-launch-meta-tab">
                <div class="mb-3">
                  <label class="form-label fw-semibold"
                         for="{{ launch_form.filename.id_for_label }}">
                    {{ launch_form.filename.label }}
                  </label>
                  {{ launch_form.filename }}
                  {% if launch_form.filename.help_text %}
                    <div class="form-text">
                      {{ launch_form.filename.help_text }}
                    </div>
                  {% endif %}
                  {{ launch_form.filename.errors }}
                </div>
                <div class="mb-3">
                  <label class="form-label fw-semibold"
                         for="{{ launch_form.metadata.id_for_label }}">
                    {{ launch_form.metadata.label }}
                  </label>
                  {{ launch_form.metadata }}
                  {% if launch_form.metadata.help_text %}
                    <div class="form-text">
                      {{ launch_form.metadata.help_text }}
                    </div>
                  {% endif %}
                  {{ launch_form.metadata.errors }}
                </div>
              </div>
            </div>
          </div>
          <div class="card-footer d-flex flex-column flex-md-row gap-3 align-items-start align-items-md-center justify-content-between">
            <small class="text-muted">
              {% blocktrans trimmed %}
                The workflow runs asynchronously. Leave this tab open to watch progress.
              {% endblocktrans %}
            </small>
            <button type="submit" class="btn btn-success ms-md-auto" data-launch-submit>
              <span id="workflow-launch-submit-indicator"
                    class="spinner-border spinner-border-sm me-2 htmx-indicator"
                    role="status"
                    aria-hidden="true"></span>
              {% trans "Start Validation" %}
            </button>
          </div>
        </form>
      </div>
    </div>
    <div class="col-12 col-xl-5 d-flex flex-column flex-grow-1">
      {% if active_run %}
        <div id="workflow-launch-run-status">
          {% include "workflows/launch/_run_status.html" with workflow=workflow run=active_run step_runs=active_run_step_runs findings=active_run_findings is_polling=active_run_is_polling polling_statuses=polling_statuses status_url=None %}
        </div>
      {% else %}
        <div class="card app-card launch-status-card">
          <div class="card-body d-flex flex-column justify-content-center align-items-center text-center text-muted p-5">
            <i class="bi-rocket text-secondary display-5 mb-3"></i>
            <p class="mb-0">
              {% trans "Submit content to monitor the validation run here." %}
            </p>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
  <script>
    (function() {
      const form = document.querySelector("#workflow-launch-form");
      if (!form) {
        return;
      }

      const modeButtons = form.querySelectorAll("[data-content-mode]");
      const uploadSection = form.querySelector("[data-upload-section]");
      const pasteSection = form.querySelector("[data-paste-section]");
      const payloadField = pasteSection ? pasteSection.querySelector("textarea") : null;
      const fileInput = form.querySelector("[data-dropzone-input]");
      const dropzone = form.querySelector("[data-dropzone]");
      const dropzoneLabel = form.querySelector("[data-dropzone-file]");
      const browseButton = form.querySelector("[data-dropzone-browse]");
      const submitButton = form.querySelector("[data-launch-submit]");

      const setSubmitState = () => {
        if (!submitButton) {
          return;
        }
        const hasPayload = Boolean(payloadField && payloadField.value.trim());
        const hasAttachment = Boolean(fileInput && fileInput.files && fileInput.files.length > 0);
        const isReady = hasPayload || hasAttachment;
        submitButton.disabled = !isReady;
        submitButton.setAttribute("aria-disabled", String(!isReady));
      };

      const setMode = (mode) => {
        modeButtons.forEach((btn) => {
          btn.classList.toggle("active", btn.getAttribute("data-content-mode") === mode);
        });
        if (uploadSection) {
          uploadSection.classList.toggle("d-none", mode !== "upload");
        }
        if (pasteSection) {
          pasteSection.classList.toggle("d-none", mode !== "paste");
        }
        if (mode === "upload" && payloadField) {
          payloadField.value = "";
          setSubmitState();
        }
        if (mode === "paste" && fileInput) {
          fileInput.value = "";
          updateFileLabel();
          setSubmitState();
        }
      };

      modeButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          setMode(btn.getAttribute("data-content-mode"));
        });
      });

      const updateFileLabel = () => {
        if (!dropzoneLabel || !fileInput) {
          return;
        }
        if (fileInput.files && fileInput.files.length > 0) {
          dropzoneLabel.textContent = fileInput.files[0].name;
          dropzoneLabel.classList.add("text-body");
          dropzoneLabel.classList.remove("text-muted");
        } else {
          dropzoneLabel.textContent = "{{ _('No file selected yet.')|escapejs }}";
          dropzoneLabel.classList.add("text-muted");
        }
        setSubmitState();
      };

      const bindDropzone = () => {
        if (!dropzone || !fileInput) {
          return;
        }

        const preventDefaults = (event) => {
          event.preventDefault();
          event.stopPropagation();
        };

        ["dragenter", "dragover"].forEach((type) => {
          dropzone.addEventListener(type, (event) => {
            preventDefaults(event);
            dropzone.classList.add("is-dragover");
          });
        });

        ["dragleave", "drop"].forEach((type) => {
          dropzone.addEventListener(type, (event) => {
            preventDefaults(event);
            dropzone.classList.remove("is-dragover");
          });
        });

        dropzone.addEventListener("drop", (event) => {
          const files = event.dataTransfer?.files;
          if (!files || files.length === 0) {
            return;
          }
          fileInput.files = files;
          updateFileLabel();
        });

        dropzone.addEventListener("click", () => fileInput.click());
        dropzone.addEventListener("keypress", (event) => {
          if (event.key === "Enter" || event.key === " ") {
            event.preventDefault();
            fileInput.click();
          }
        });

        fileInput.addEventListener("change", updateFileLabel);
        if (browseButton) {
          browseButton.addEventListener("click", (event) => {
            event.preventDefault();
            fileInput.click();
          });
        }
      };

      if (payloadField) {
        payloadField.addEventListener("input", setSubmitState);
      }

      setMode("upload");
      bindDropzone();
      updateFileLabel();
      setSubmitState();
    })();
  </script>
{% endif %}
