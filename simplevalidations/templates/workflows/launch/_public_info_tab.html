{% load i18n humanize static %}

<div class="public-workflow-hero card border-0 shadow-sm overflow-hidden">
  {% if workflow.has_featured_image %}
    <div class="ratio ratio-21x9 bg-body-tertiary hero-image">
      <img src="{{ workflow.get_featured_image_url }}"
           alt="{{ workflow.get_featured_image_alt }}"
           class="object-fit-cover w-100 h-100" />
    </div>
  {% endif %}
  <div class="card-body p-4 p-lg-5 validation-steps-card">
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start gap-4">
      <div class="flex-grow-1 w-50">
        <p class="text-uppercase text-muted fw-semibold mb-3 small">
          {% trans "SimpleValidation Workflow" %}
        </p>
        <h1 class="display-6 fw-semibold mb-2">
          {{ workflow.name }}
        </h1>
      </div>
      <div class="bg-body-tertiary rounded-3 p-3 w-50 w-lg-auto">
        <dl class="row small mb-0">
          <dt class="col-sm-5 text-uppercase text-muted fw-semibold">
            {% trans "Created" %}
          </dt>
          <dd class="col-sm-7">
            {{ workflow.created|date:"M j, Y" }} · {{ workflow.created|naturaltime }}
          </dd>
          <dt class="col-sm-5 text-uppercase text-muted fw-semibold">
            {% trans "Updated" %}
          </dt>
          <dd class="col-sm-7">
            {{ workflow.modified|date:"M j, Y" }} · {{ workflow.modified|naturaltime }}
          </dd>
          <dt class="col-sm-5 text-uppercase text-muted fw-semibold">
            {% trans "UUID" %}
          </dt>
          <dd class="col-sm-7">
            <code>{{ workflow.uuid }}</code>
          </dd>
          <dt class="col-sm-5 text-uppercase text-muted fw-semibold">
            {% trans "Slug" %}
          </dt>
          <dd class="col-sm-7">
            <code>{{ workflow.slug }}</code>
          </dd>
        </dl>

      </div>
    </div>
  </div>
  {# login call to action #}
  <div class="alert alert-info my-3 mx-5" role="alert">
    <div class="d-flex flex-column flex-lg-row align-items-start align-items-lg-center gap-3">
      <div class="d-flex align-items-center gap-2">
        <i class="bi-info-circle-fill fs-4"></i>
        <span class="fw-semibold">
          {% trans "Workflow access" %}
        </span>
      </div>
      <div class="flex-grow-1">
        {% if request.user.is_authenticated %}
          {% if user_has_access %}
            {% blocktrans %}
                  You can manage this workflow from the internal app.
                {% endblocktrans %}
          {% else %}
            {% blocktrans %}
                  You do not currently have permission to run this workflow. Contact the workflow owner to request access.
                {% endblocktrans %}
          {% endif %}
        {% else %}
          {% blocktrans %}
                Sign in to your SimpleValidations account to request access or launch this workflow.
              {% endblocktrans %}
        {% endif %}
      </div>
      <div class="ms-lg-auto d-flex gap-2">
        {% if request.user.is_authenticated %}
          <a href="{% url 'workflows:workflow_launch' workflow.pk %}"
             class="btn btn-primary">
            {% trans "Open in app" %}
          </a>
        {% else %}
          <a href="{% url 'account_login' %}" class="btn btn-outline-primary">
            {% trans "Sign in" %}
          </a>
          <a href="{% url 'account_signup' %}" class="btn btn-primary">
            {% trans "Start trial" %}
          </a>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% if public_info.get_html_content %}
  <div class="card border-0 shadow-sm mt-4">
    <div class="card-header bg-white py-3 px-4">
      {% trans "Description" %}
    </div>
    <div class="card-body p-4 p-lg-5">
      <div class="markdown-content">
        {{ public_info.get_html_content|safe }}
      </div>
    </div>
  </div>
{% endif %}

{% if steps %}
  <div class="card border-0 shadow-sm mt-4 public-steps-card">
    <div class="card-header bg-white py-3 px-4">
      {% trans "Workflow Validation Steps" %}
    </div>
    <div class="card-body p-4 p-lg-5 ">
      {% for step in steps %}
        <div class="public-step-item">
          <div class="public-step-card">
            <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
              <span class="badge text-bg-primary badge-step-index">{% trans "Step" %} {{ forloop.counter }}</span>
              <h3 class="h6 mb-0">
                {{ step.name|default:step.validator.name }}
              </h3>
            </div>
            {% if step.description %}
              <p class="text-muted mb-3">
                {{ step.description|linebreaksbr }}
              </p>
            {% endif %}
            {% comment %}
            <div class="text-muted small">
              <span>{% trans "Validator" %}: {{ step.validator.name }}</span>
              {% if step.ruleset %}
                · <span>{% trans "Ruleset" %}: {{ step.ruleset.name }}</span>
              {% endif %}
            </div>
            {% endcomment %}
            {% if step.public_schema %}
              <div class="mt-3">
                <button class="btn btn-sm btn-outline-secondary"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#schema-detail-{{ step.id }}"
                        aria-expanded="false"
                        aria-controls="schema-detail-{{ step.id }}">
                  {% trans "Show schema" %}
                </button>
                <div class="collapse mt-3" id="schema-detail-{{ step.id }}">
                  <pre class="bg-body-tertiary p-3 rounded overflow-auto">
<code class="language-{{ step.public_schema.language|default:'text' }}">{{ step.public_schema.content|escape }}</code>
                    </pre>
                </div>
              </div>
            {% endif %}
          </div>
        </div>
        {% if not forloop.last and steps|length > 1 %}
          <div class="workflow-step-connector" aria-hidden="true">
            <div class="workflow-step-arrow">
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>
{% endif %}
