{% load i18n core_tags static %}

{% comment %}
This template partial contains the detail we want to show when a run is done and we're no longer polling.
So the run might have completed successfully, failed, or been canceled.
{% endcomment %}

<div class="card-body d-flex flex-column justify-content-start align-items-start">

    <dl class="row mb-3 small">
        <dt class="col-5 col-lg-4">
            {% trans "Started" %}
        </dt>
        <dd class="col-7 col-lg-8">
            {{ run.started_at|date:"M j, Y g:i a"|default:_("Pending") }}
        </dd>
        <dt class="col-5 col-lg-4">
            {% trans "Completed" %}
        </dt>
        <dd class="col-7 col-lg-8">
            {{ run.ended_at|date:"M j, Y g:i a"|default:_("Pending") }}
        </dd>
        <dt class="col-5 col-lg-4">
            {% trans "Duration" %}
        </dt>
        <dd class="col-7 col-lg-8">
            {% with duration=run.computed_duration_ms %}
                {% if duration %}
                    {{ duration|floatformat:0 }} ms
                {% elif is_polling %}
                    <span class="text-muted">{% trans "Runningâ€¦" %}</span>
                {% else %}
                    <span class="text-muted">{% trans "Not captured" %}</span>
                {% endif %}
            {% endwith %}
        </dd>
    </dl>
    {% if run.error %}
        <div class="alert alert-danger small" role="alert">
            <i class="bi-exclamation-octagon me-2"></i>{{ run.error }}
        </div>
    {% endif %}
    <div class="mb-4">
        <h2 class="h6 d-flex align-items-center gap-2 mb-3">
            <i class="bi-list-check"></i>
            {% trans "Step status" %}
        </h2>
        {% with summary=run.summary %}
            {% if step_runs %}
                <ul class="list-group list-group-flush">
                    {% for step_run in step_runs %}
                        <li class="list-group-item px-0 d-flex align-items-center justify-content-between">
                            <div>
                                <span class="fw-semibold">
                                    {% if step_run.workflow_step %}
                                        {{ step_run.workflow_step.name|default:_("Step") }}
                                    {% else %}
                                        {% trans "Step" %}
                                    {% endif %}
                                </span>
                                <div class="text-muted small">
                                    {% if step_run.workflow_step and step_run.workflow_step.validator %}
                                        {{ step_run.workflow_step.validator.get_validation_type_display }}
                                    {% endif %}
                                </div>
                            </div>
                            <span class="badge text-bg-light text-uppercase">
                                {{ step_run.get_status_display }}
                            </span>
                        </li>
                    {% endfor %}
                </ul>
            {% elif summary.steps %}
                {% if summary.overview %}
                    <p class="text-muted small mb-2">
                        {{ summary.overview }}
                    </p>
                {% endif %}
                <ul class="list-group list-group-flush">
                    {% for step in summary.steps %}
                        <li class="list-group-item px-0">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <span class="fw-semibold">{{ step.name|default:_("Step") }}</span>
                                    <div class="text-muted small">
                                        {{ step.status|title }}
                                    </div>
                                </div>
                                <span class="badge text-bg-light text-uppercase">
                                    {{ step.status|title }}
                                </span>
                            </div>
                            {% if step.issues %}
                                <ul class="text-muted small ps-3 mb-0 mt-2">
                                    {% for issue in step.issues %}
                                        <li>
                                            {% if issue.severity %}
                                                <span class="badge text-bg-secondary text-uppercase me-1">{{ issue.severity|default:"ERROR" }}</span>
                                            {% endif %}
                                            {{ issue.message }}
                                            {% if issue.path %}
                                                <div class="text-muted">
                                                    {{ issue.path }}
                                                </div>
                                            {% endif %}
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% elif step.error %}
                                <div class="text-danger small mt-2">
                                    {{ step.error }}
                                </div>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted small mb-0">
                    {% trans "Step details will appear once execution begins." %}
                </p>
            {% endif %}
        {% endwith %}
    </div>
    <div class="mb-4">
        <h2 class="h6 d-flex align-items-center gap-2 mb-3">
            <i class="bi-flag"></i>
            {% trans "Findings" %}
        </h2>
        {% with summary=run.summary %}
            {% if findings %}
                <ul class="list-group list-group-flush">
                    {% for finding in findings %}
                        <li class="list-group-item px-0">
                            <span class="badge text-bg-secondary text-uppercase me-2">{{ finding.get_severity_display }}</span>
                            {{ finding.message|truncatechars:160 }}
                            {% if finding.path %}
                                <div class="small text-muted">
                                    <i class="bi-diagram-3 me-1"></i>{{ finding.path }}
                                </div>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted small mb-0">
                    {% if run.status == "SUCCEEDED" %}
                        {% trans "No findings recorded for this run." %}
                    {% elif summary.steps %}
                        {% trans "Refer to the step details above for validation issues." %}
                    {% else %}
                        {% trans "Findings will be listed once available." %}
                    {% endif %}
                </p>
            {% endif %}
        {% endwith %}
    </div>

</div>
