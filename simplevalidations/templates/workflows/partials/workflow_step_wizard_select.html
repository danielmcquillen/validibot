{% load i18n %}

<div class="modal-header">
  <div>
    <h5 class="modal-title">
      {% trans "Add workflow step" %}
    </h5>
    <p class="text-muted small mb-0">
      {% trans "Choose the type of operation to run in this step." %}
    </p>
  </div>
  <button type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="{% trans 'Close' %}">
  </button>
</div>
<div class="modal-body p-0">
  {% if limit_reached %}
    <div class="alert alert-warning" role="alert">
      {% blocktrans with max=max_step_count %}
        This workflow already has {{ max }} steps. Remove a step before adding another.
      {% endblocktrans %}
    </div>
  {% else %}
    <form method="post"
          hx-post="{% url 'workflows:workflow_step_wizard' workflow.pk %}"
          hx-target="#workflow-step-modal-content"
          hx-swap="innerHTML"
          class="d-flex flex-column h-100">
      {% csrf_token %}
      <input type="hidden" name="stage" value="select" />
      {% if form.errors %}
        <div class="alert alert-danger" role="alert">
          {% for error in form.non_field_errors %}
            <div>
              {{ error }}
            </div>
          {% endfor %}
          {% for field in form %}
            {% for error in field.errors %}
              <div>
                {{ error }}
              </div>
            {% endfor %}
          {% endfor %}
        </div>
      {% endif %}
      <div class="card shadow-sm flex-grow-1 d-flex flex-column">
        <div class="card-body d-flex flex-column">
          <ul class="nav nav-tabs" role="tablist">
            {% for tab in validator_tabs %}
              <li class="nav-item" role="presentation">
                <button class="nav-link {% if tab.slug == selected_tab %}active{% endif %}"
                        id="workflow-tab-{{ tab.slug }}-tab"
                        data-bs-toggle="tab"
                        type="button"
                        role="tab"
                        data-bs-target="#workflow-tab-{{ tab.slug }}"
                        aria-controls="workflow-tab-{{ tab.slug }}"
                        aria-selected="{% if tab.slug == selected_tab %}true{% else %}false{% endif %}">
                  {{ tab.label }}
                </button>
              </li>
            {% endfor %}
          </ul>
          <div class="tab-content pt-3 flex-grow-1 d-flex flex-column">
            {% for tab in validator_tabs %}
              <div class="tab-pane fade {% if tab.slug == selected_tab %}show active{% endif %} flex-grow-1"
                   id="workflow-tab-{{ tab.slug }}"
                   role="tabpanel"
                   aria-labelledby="workflow-tab-{{ tab.slug }}-tab">
                {% if tab.entries %}
                  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xxl-4 g-4 align-items-stretch">
                    {% for entry in tab.entries %}
                      {% with input_id='step-option-'|add:entry.value|slugify %}
                        <div class="col">
                          <input class="btn-check step-option"
                                 type="radio"
                                 name="choice"
                                 id="{{ input_id }}"
                                 value="{{ entry.value }}"
                                 {% if selected_value and selected_value|stringformat:'s' == entry.value|stringformat:'s' %}
                                   checked
                                 {% endif %}
                                 autocomplete="off"
                                 required>
                          <label class="validator-card h-100 {% if selected_value and selected_value|stringformat:'s' == entry.value|stringformat:'s' %}is-selected{% endif %}"
                                 for="{{ input_id }}">
                            <div class="validator-card__icon mb-3">
                              <i class="bi {{ entry.icon }}"></i>
                            </div>
                            <div class="validator-card__title mb-1">
                              {{ entry.name }}
                            </div>
                            <div class="validator-card__subtitle text-uppercase">
                              {{ entry.subtitle }}
                            </div>
                            {% if entry.description %}
                              <p class="validator-card__description small mb-0 mt-2">
                                {{ entry.description }}
                              </p>
                            {% endif %}
                          </label>
                        </div>
                      {% endwith %}
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="alert alert-info mb-0" role="alert">
                    {% trans "No options available yet." %}
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        </div>
        <div class="card-footer bg-body-tertiary d-flex justify-content-end gap-2">
          <button type="button"
                  class="btn btn-outline-secondary"
                  data-bs-dismiss="modal">
            {% trans "Cancel" %}
          </button>
          <button type="submit" class="btn btn-primary">
            {% trans "Continue" %}
          </button>
        </div>
      </div>
    </form>
    <script>
      (function() {
        const initSelection = () => {
          const container = document.getElementById('workflow-step-modal-content');
          if (!container) {
            return;
          }

          const inputs = container.querySelectorAll('.step-option');
          const toggleSelection = (selectedInput) => {
            container.querySelectorAll('.validator-card').forEach((card) => {
              card.classList.remove('is-selected');
            });
            if (!selectedInput) {
              return;
            }
            const label = container.querySelector(`label[for="${selectedInput.id}"]`);
            if (label) {
              label.classList.add('is-selected');
            }
          };

          inputs.forEach((input) => {
            if (input.checked) {
              toggleSelection(input);
            }
            input.addEventListener('change', (event) => {
              if (event.currentTarget.checked) {
                toggleSelection(event.currentTarget);
              }
            });
          });
        };

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initSelection);
        } else {
          initSelection();
        }

        document.body.addEventListener('htmx:afterSwap', function(event) {
          if (event.detail.target.id === 'workflow-step-modal-content') {
            setTimeout(initSelection, 10);
          }
        });
      })();
    </script>
  {% endif %}
</div>
