{% extends "app_base.html" %}

{% load i18n core_tags %}

{% block title %}
  {{ workflow.name }} · {% trans "Workflows" %} · SimpleValidations
{% endblock title %}

{% block left_sidebar %}
  {% include "app/partial/components/app_left_nav.html" %}
{% endblock left_sidebar %}

{% block app_content %}
  <div id="workflow-detail" class="container-fluid">

    <div class="app-content-header-bar row ">
      <div class="app-content-header col-12 col-lg-4 d-flex align-items-start mb-2 mb-lg-0">
        <div class="d-flex flex-column gap-2">
          <div class="d-flex flex-wrap align-items-center gap-2">
            <h1 class="app-page-title mb-0">
              <i class="bi bi-box me-2"></i>Workflow: {{ workflow.name }}
            </h1>
          </div>
          {% if workflow.version %}
            <div class="text-muted small">
              <i class="bi-tag me-1"></i>{% trans "Version" %} {{ workflow.version }}
            </div>
          {% endif %}
        </div>
      </div>

      <div class="col-12 col-lg-8 d-flex flex-column align-items-end">
        <div class="d-flex flex-wrap gap-2 justify-content-end">

          {# link to launch #}
          <a class="btn btn-light"
             data-bs-toggle="tooltip"
             data-bs-placement="top"
             title="{% trans "Start a new validation run with this workflow" %}"
             href="{% url 'workflows:workflow_launch' workflow.pk %}">
            <i class="bi-rocket me-1"></i>
          </a>

          <a class="btn btn-light"
             data-bs-toggle="tooltip"
             data-bs-placement="top"
             title="{% trans "View Validations" %}"
             href="{{ related_validations_url }}">
            <i class="bi-diagram-3"></i>
          </a>
          <a class="btn btn-danger"
             hx-delete="{% url 'workflows:workflow_delete' workflow.pk %}"
             hx-target="body"
             data-bs-toggle="tooltip"
             data-bs-placement="top"
             title="{% trans "Delete this workflow" %}"
             hx-confirm="{% trans "Delete this workflow?" %}">
            <i class="bi-trash"></i>
          </a>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-12 col-lg-6 col-xxl-8">
        <div class="card shadow-sm mb-4" id="workflow-step-editor-card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              <span class="fw-semibold">{% trans "Workflow steps" %}</span>
              <span class="text-muted small ms-2">{% trans "Design the sequence of validations (max five steps)." %}</span>
            </div>
            <button class="btn btn-primary btn-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#workflowStepModal"
                    hx-get="{% url 'workflows:workflow_step_wizard' workflow.pk %}"
                    hx-target="#workflow-step-modal-content"
                    hx-swap="innerHTML">
              <i class="bi-plus-lg me-1"></i>{% trans "Add step" %}
            </button>
          </div>
          <div class="card-body editor-workspace">
            <div id="steps-list"
                 hx-get="{% url 'workflows:workflow_step_list' workflow.pk %}"
                 hx-trigger="load, steps-changed from:body"
                 hx-target="this"
                 hx-swap="innerHTML">
              {% include "workflows/partials/workflow_step_list.html" with workflow=workflow steps=workflow.steps.all max_step_count=max_step_count %}
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-6 col-xxl-4">
        <div class="card shadow-sm mb-3">
          <div class="card-header d-flex align-items-center">
            <div class="d-flex align-items-center gap-2 me-auto">
              <span class="fw-semibold">{% trans "Workflow Details" %}</span>
              {% if workflow.is_locked %}
                <span class="badge text-bg-warning">{% trans "Locked" %}</span>
              {% endif %}
            </div>
            {% if can_manage_activation %}
              <form method="post"
                    action="{% org_url 'workflows:workflow_activation' pk=workflow.pk %}">
                {% csrf_token %}
                {% if workflow.is_active %}
                  <input type="hidden" name="is_active" value="false" />
                  <button type="submit"
                          data-bs-toggle="tooltip"
                          data-bs-placement="top"
                          title="{% trans 'Disable workflow' %}"
                          class="btn btn-warning btn-sm">
                    <i class="bi-pause-circle"></i>
                  </button>
                {% else %}
                  <input type="hidden" name="is_active" value="true" />
                  <button type="submit"
                          data-bs-toggle="tooltip"
                          data-bs-placement="top"
                          title="{% trans 'Enable workflow' %}"
                          class="btn btn-success btn-sm">
                    <i class="bi-play-circle me"></i>
                  </button>
                {% endif %}
              </form>
            {% endif %}
            <a class="btn btn-sm btn-light ms-2"
               href="{% org_url 'workflows:workflow_update' pk=workflow.pk %}"
               aria-label="{% trans "Edit workflow details" %}"
               data-bs-toggle="tooltip"
               data-bs-placement="top"
               title="{% trans "Workflow settings" %}">
              <i class="bi bi-gear-fill"></i>
            </a>
          </div>
          {% if workflow.has_featured_image %}
            <img src="{{ workflow.get_featured_image_url }}"
                 class="card-img-top"
                 alt="{% blocktrans with name=workflow.name %}
                        Image for workflow {{ name }}
                      {% endblocktrans %}" />
          {% endif %}
          <div class="card-body">

            <dl class="row mb-0">
              <dt class="col-sm-4">
                {% trans "Name" %}
              </dt>
              <dd class="col-sm-8">
                {{ workflow.name }}
              </dd>
              <dt class="col-sm-4">
                {% trans "Status" %}
              </dt>
              <dd class="col-sm-8">
                <div class="d-flex flex-column gap-2">
                  <div>
                    {% if workflow.is_active %}
                      <span class="badge text-bg-success">{% trans "Active" %}</span>
                    {% else %}
                      <span class="badge text-bg-secondary">{% trans "Inactive" %}</span>
                    {% endif %}
                  </div>
                  <small class="text-muted">
                    {% trans "Inactive workflows stay visible in the catalog but block new validation runs." %}
                  </small>

                </div>
              </dd>

              <dt class="col-sm-4">
                {% trans "Info visibility" %}
              </dt>
              <dd class="col-sm-8">
                {% if public_info_url %}
                  <div class="d-flex flex-row flex-wrap gap-2 align-items-center">
                    <span class="badge text-bg-primary align-self-start me-2">
                      {% trans "Public" %}
                    </span>
                    <a href="{{ public_info_url }}"
                       target="_blank"
                       rel="noopener"
                       class="btn btn-link btn-sm px-0">
                      <i class="bi-box-arrow-up-right me-1"></i>{% trans "View public info" %}
                    </a>
                    <a class="btn btn-sm btn-outline-primary"
                       href="{% org_url 'workflows:workflow_public_info_edit' pk=workflow.pk %}">
                      <i class="bi-pencil me-1"></i>{% trans "Edit public info" %}
                    </a>
                  </div>
                {% else %}
                  <div class="d-flex flex-row flex-wrap gap-2 align-items-center">
                    <span class="badge text-bg-secondary">
                      {% trans "Private" %}
                    </span>
                    <a class="btn btn-sm btn-outline-primary"
                       href="{% org_url 'workflows:workflow_public_info_edit' pk=workflow.pk %}">
                      <i class="bi-pencil me-1"></i>{% trans "Add public info" %}
                    </a>
                  </div>
                {% endif %}
              </dd>

              <dt class="col-sm-4">
                {% trans "Slug" %}
              </dt>
              <dd class="col-sm-8">
                {{ workflow.slug }}
              </dd>

              <dt class="col-sm-4">
                {% trans "Version" %}
              </dt>
              <dd class="col-sm-8">
                {{ workflow.version|default:_("Not set") }}
              </dd>

              <dt class="col-sm-4">
                {% trans "Created" %}
              </dt>
              <dd class="col-sm-8">
                {{ workflow.created|date:"M j, Y g:i a" }}
              </dd>

              {% comment %}
              <dt class="col-sm-4">
                {% trans "Updated" %}
              </dt>
              <dd class="col-sm-8">
                {{ workflow.modified|date:"M j, Y g:i a" }}
              </dd>
              {% endcomment %}

              <dt class="col-sm-4">
                {% trans "Created by" %}
              </dt>
              <dd class="col-sm-8">
                {{ workflow.user.name|default:workflow.user.username }}
              </dd>
            </dl>
            <hr class="my-4" />
            <div class="bg-body-tertiary border rounded-3 p-3">
              <div class="d-flex align-items-center gap-2 mb-3">
                <span class="badge text-bg-primary">{% trans "API" %}</span>
                <div>
                  <div class="fw-semibold mb-0">
                    {% trans "Start this workflow via API" %}
                  </div>
                  <small class="text-muted">{% trans "POST requests launch a validation run for this workflow." %}</small>
                </div>
              </div>
              <ul class="list-unstyled small text-muted mb-3">
                <li>
                  <span class="fw-semibold me-1">{% trans "Endpoint" %}:</span>
                  <code class="text-body-secondary">POST /api/v1/workflows/{{ workflow.pk }}/start/</code>
                </li>
                <li>
                  <span class="fw-semibold me-1">{% trans "Auth" %}:</span>
                  {% blocktrans with org_name=workflow.org.name %}Bearer token with the Executor role in {{ org_name }}.{% endblocktrans %}
                </li>
                <li>
                  <span class="fw-semibold me-1">{% trans "Content" %}:</span>
                  {% trans "Send raw content, a JSON envelope, or multipart form-data." %}
                </li>
              </ul>
              <pre class="bg-dark text-white rounded-3 p-3 small mb-2"><code>curl -X POST https://{{ request.get_host|default:"api.simplevalidations.io" }}/api/v1/workflows/{{ workflow.pk }}/start/ \
  -H "Authorization: Token &lt;token&gt;" \
  -H "Content-Type: application/json" \
  -d '{
    "content": "{ \"example\": true }",
    "content_type": "application/json",
    "filename": "sample.json"
  }'</code></pre>
              <p class="small text-muted mb-0">
                {% trans "See the developer guide 'Using a Workflow via the API' for additional payload examples." %}
              </p>
            </div>
          </div>
        </div>
        <div class="card shadow-sm">
          <div class="card-header">
            <span class="fw-semibold">{% trans "Recent Validations" %}</span>
          </div>
          <div class="card-body">
            {% if recent_runs %}
              <div class="list-group list-group-flush">
                {% for run in recent_runs %}
                  <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                     href="{% url 'validations:validation_detail' run.pk %}">
                    <div>
                      <div class="fw-semibold">
                        {% trans "Run" %} #{{ run.pk }}
                      </div>
                      <small class="text-muted">{{ run.created|date:"M j, Y g:i a" }}</small>
                    </div>
                    <span class="badge rounded-pill text-bg-secondary {{ run.status_pill_class }}">{{ run.get_status_display }}</span>
                  </a>
                {% endfor %}
              </div>
            {% else %}
              <p class="text-muted mb-0">
                {% trans "No validations have been recorded for this workflow yet." %}
              </p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock app_content %}

{% block modal %}
  {{ block.super }}
  <div class="modal fade"
       id="workflowStepModal"
       tabindex="-1"
       aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content" id="workflow-step-modal-content">
      </div>
    </div>
  </div>
{% endblock modal %}

{% block inline_javascript %}
  {{ block.super }}
  <script>
    document.body.addEventListener('close-modal', function(event) {
      const detail = event?.detail;
      const targetId =
        (typeof detail === 'string' && detail) ||
        detail?.value ||
        detail?.['close-modal'] ||
        'workflowStepModal';
      if (!targetId) {
        return;
      }
      const modalEl = document.getElementById(targetId);
      if (!modalEl) {
        return;
      }
      let modal = bootstrap.Modal.getInstance(modalEl);
      if (!modal) {
        modal = new bootstrap.Modal(modalEl);
      }
      modal.hide();
    });
  </script>
{% endblock inline_javascript %}
