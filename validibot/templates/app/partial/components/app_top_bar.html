{% load static i18n core_tags %}

{% comment %}
App top bar component.

This component renders the top navigation bar for the app, with support for
restricted mode when the user's subscription is blocked (expired trial,
suspended, canceled).

In restricted mode:
- Nav toggle button is hidden
- Notifications bell is hidden
- User menu shows only sign out option
- "Back to Validibot" link is shown

Uses `app_ui` context from billing.context_processors.app_ui_state_context.
{% endcomment %}

<div id="app-top-bar">

    {# Nav toggle button - hidden in restricted mode #}
    {% if app_ui.show_nav_toggle %}
        <div id="expand-collapse-btn-wrapper">
            <button id="app-left-nav-toggle"
                    class="btn btn-sm btn-light"
                    type="button"
                    aria-controls="app-left-nav"
                    aria-expanded="true"
                    aria-label="{% trans 'Hide navigation' %}"
                    data-expanded-label="{% trans 'Hide navigation' %}"
                    data-collapsed-label="{% trans 'Show navigation' %}">
                <i class="bi bi-list"></i>
            </button>
        </div>
    {% endif %}

    <div id="breadcrumbs-wrapper"
         class="
                {% block breadcrumbs_styles %}
                {% endblock breadcrumbs_styles %}">

        {# Back to site link - shown in restricted mode #}
        {% if app_ui.show_back_to_site_link %}
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item">
                        <a href="{% url 'marketing:home' %}" class="text-decoration-none">
                            <i class="bi bi-arrow-left me-1"></i>{% trans "Back to Validibot Site" %}
                        </a>
                    </li>
                </ol>
            </nav>
        {% else %}
            {% include "core/partial/breadcrumbs.html" %}
        {% endif %}
    </div>

    <div class="app-header-right">
        {# Notifications bell - hidden in restricted mode #}
        {% if app_ui.show_notifications %}
            <div class="me-3">
                <a href="{% url 'notifications:notification-list' %}"
                   class="btn btn-dark position-relative notification-bell-btn"
                   data-bs-toggle="tooltip"
                   data-bs-placement="bottom"
                   title="{% trans 'Notifications' %}"
                   aria-label="{% trans 'Notifications' %}">
                    <i class="bi bi-bell-fill"></i>
                    {% if unread_notification_count %}
                        <span class="badge rounded-pill bg-danger notification-bell-badge">
                            {{ unread_notification_count }}
                            <span class="visually-hidden">{% trans "unread notifications" %}</span>
                        </span>
                    {% endif %}
                </a>
            </div>
        {% endif %}

        <div id="user-profile-selector" class="dropdown">
            <button class="btn btn-dark d-inline-flex align-items-center justify-content-center p-0 rounded-circle overflow-hidden"
                    type="button"
                    id="app-user-menu"
                    data-bs-toggle="dropdown"
                    aria-haspopup="true"
                    aria-expanded="false"
                    aria-label="{% trans 'Open user menu' %}">
                {% if request.user.avatar %}
                    <img src="{{ request.user.avatar.url }}"
                         alt="{% trans 'User avatar' %}"
                         class="object-fit-cover user-avatar" />
                {% else %}
                    {% with avatar_source=request.user.name|default:request.user.username %}
                        {% if avatar_source %}
                            {{ avatar_source|first|upper }}
                        {% else %}
                            ?
                        {% endif %}
                    {% endwith %}
                {% endif %}
                <span class="visually-hidden">
                    {{ request.user.name|default:request.user.username }}
                </span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow-sm"
                aria-labelledby="app-user-menu">
                <li class="dropdown-header">
                    <span class="fw-semibold">{{ request.user.name|default:request.user.username }}</span>
                    {% if request.user.email %}
                        <span class="text-muted">{{ request.user.email }}</span>
                    {% endif %}
                </li>

                {# Full menu items - hidden in restricted mode #}
                {% if app_ui.show_full_user_menu %}
                    <li>
                        <a class="dropdown-item
                                  {% if user_settings_nav.profile %}
                                      active
                                  {% endif %}"
                           href="{% org_url 'users:profile' %}">
                            {% trans "User Profile" %}
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item
                                  {% if user_settings_nav.email %}
                                      active
                                  {% endif %}"
                           href="{% org_url 'users:email' %}">
                            {% trans "User Email" %}
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item
                                  {% if user_settings_nav.api_key %}
                                      active
                                  {% endif %}"
                           href="{% org_url 'users:api-key' %}">
                            {% trans "API Key" %}
                        </a>
                    </li>
                    <hr class="dropdown-divider" />
                    <li>
                        <a class="dropdown-item d-flex justify-content-between align-items-center"
                           href="{% url 'notifications:notification-list' %}">
                            {% trans "Notifications" %}
                            {% if unread_notification_count %}
                                <span class="badge rounded-pill bg-danger">
                                    {{ unread_notification_count }}
                                </span>
                            {% endif %}
                        </a>
                    </li>
                    {% if is_org_admin %}
                        {# divider #}
                        <hr class="dropdown-divider" />
                        <li>
                            <a class="dropdown-item
                                      {% if user_settings_nav.organizations %}
                                          active
                                      {% endif %}"
                               href="{% org_url 'users:organization-list' %}">
                                {% trans "Manage organizations" %}
                            </a>
                        </li>
                    {% endif %}
                {% endif %}

                {# Sign out - always visible #}
                {% if ACCOUNT_ALLOW_LOGIN %}
                    <li>
                        <hr class="dropdown-divider" />
                    </li>
                    <li>
                        <a class="dropdown-item text-danger" href="{% url 'account_logout' %}">
                            {% trans "Sign Out" %}
                        </a>
                    </li>
                {% endif %}
            </ul>
        </div>
    </div>
</div>
