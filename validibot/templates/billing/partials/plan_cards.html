{% comment %}
Plan cards partial template.

Renders a grid of plan cards for subscription selection. This partial can be
included in multiple pages (plans page, trial expired page, marketing pricing)
with consistent rendering.

Required context:
- all_plans: QuerySet of Plan objects

Optional context for app pages (logged-in users):
- subscription: Current Subscription object (for highlighting current plan)
- plan: Current Plan object (for "Current Plan" badge)
- highlight_intended: Boolean, if True highlights subscription.intended_plan
- show_purchase_buttons: Boolean, if True shows "Purchase Plan" instead of "Upgrade"
                         (used on trial expired page)

Optional context for marketing pages (anonymous users):
- show_signup_buttons: Boolean, if True shows "Start free trial" signup links
- highlight_plan: Plan code to highlight (e.g., "TEAM" for marketing emphasis)

The partial uses Django 6.0+ partialdef so it can be:
1. Included via {% include "billing/partials/plan_cards.html#plan_cards_grid" %}
2. Fetched via template loader for partial-only rendering
{% endcomment %}

{% load i18n humanize %}

{% partialdef plan_cards_grid %}
<div class="row g-4 justify-content-center">
  {% for p in all_plans %}
    <div class="col-md-6 col-xl-3">
      {% comment %}
      Determine card styling based on whether this is the current plan, intended plan,
      or marketing highlighted plan.
      - is_current: p.code matches the current plan code
      - is_intended: highlight_intended is True and p.code matches intended_plan.code
      - is_highlighted: highlight_plan is set and matches p.code (for marketing pages)
      {% endcomment %}
      <div class="card h-100 shadow-sm
                  {% if p.code == plan.code %}
                    border-primary
                  {% elif highlight_intended and subscription.intended_plan and p.code == subscription.intended_plan.code %}
                    border-primary
                  {% elif highlight_plan and p.code == highlight_plan %}
                    border-primary
                  {% endif %}">
        <div class="card-header
                    {% if p.code == plan.code %}
                      text-bg-primary
                    {% elif highlight_intended and subscription.intended_plan and p.code == subscription.intended_plan.code %}
                      text-bg-primary
                    {% elif highlight_plan and p.code == highlight_plan %}
                      text-bg-primary
                    {% else %}
                      text-bg-light
                    {% endif %}
                    text-center">
          <h2 class="h5 mb-0">
            {{ p.name }}
            {% if p.code == plan.code %}
              <span class="badge bg-light text-primary ms-2">{% trans "Current" %}</span>
            {% elif highlight_intended and subscription.intended_plan and p.code == subscription.intended_plan.code %}
              <span class="badge bg-light text-primary ms-2">{% trans "Your Selection" %}</span>
            {% endif %}
          </h2>
        </div>
        <div class="card-body text-center d-flex flex-column">
          <div class="pricing-content flex-grow-1">
            {% comment %}
            Display pricing: Free shows "Free", paid shows price, Enterprise shows "Contact Us"
            {% endcomment %}
            {% if p.code == "FREE" %}
              <p class="display-6 fw-bold mb-0">
                {% trans "Free" %}
              </p>
              <p class="text-muted">
                &nbsp;
              </p>
            {% elif p.monthly_price_dollars %}
              <p class="display-6 fw-bold mb-0">
                ${{ p.monthly_price_dollars }}
              </p>
              <p class="text-muted">
                {% trans "per month" %}
              </p>
            {% else %}
              <p class="display-6 fw-bold mb-0">
                {% trans "Contact Us" %}
              </p>
              <p class="text-muted">
                {% trans "Custom pricing" %}
              </p>
            {% endif %}

            <p class="text-muted small mb-3" style="min-height: 7em;">
              {{ p.description }}
            </p>

            <ul class="list-unstyled text-start">


              <li class="mb-2">
                <i class="bi bi-check-circle-fill text-success me-2"></i>
                Access public validations
              </li>
              <li class="mb-4">
                <i class="bi bi-check-circle-fill text-success me-2"></i>
                Access invite-only validations
              </li>

              {% if p.code != "FREE" %}
                <h4>
                  Authoring
                </h4>

                <li class="mb-2">
                  {% comment %}
                For Free plan with 0 workflows, show a different message
                  {% endcomment %}
                  {% if p.max_workflows == 0 %}

                  {% elif p.max_workflows %}
                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                    {{ p.max_workflows }} {% trans "validation workflows" %}
                  {% else %}
                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                    {% trans "Unlimited" %} {% trans "validation workflows" %}
                  {% endif %}
                </li>

                <li class="mb-2">
                  {% comment %}
                Custom validators - 0 means none allowed, null means unlimited
                  {% endcomment %}
                  {% if p.max_custom_validators == 0 %}

                  {% elif p.max_custom_validators %}
                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                    {{ p.max_custom_validators }} {% trans "custom validators" %}
                  {% else %}
                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                    {% trans "Unlimited" %} {% trans "custom validators" %}
                  {% endif %}
                </li>

                <li class="mb-4">
                  <i class="bi bi-check-circle-fill text-success me-2"></i>
                  {% if p.max_seats %}
                    {{ p.max_seats }}
                  {% else %}
                    {% trans "Unlimited" %}
                  {% endif %}
                  {% trans "team seats" %}
                </li>


                <h4>
                  End-User Access to Workflows
                </h4>

                <li class="mb-2">
                  <i class="bi bi-check-circle-fill text-success me-2"></i>
                  {% if p.basic_launches_limit %}
                    {{ p.basic_launches_limit|intcomma }}
                  {% else %}
                    {% trans "Unlimited" %}
                  {% endif %}
                  {% trans "basic validations / mo" %}
                </li>

                <li class="mb-2">
                  <i class="bi bi-check-circle-fill text-success me-2"></i>
                  {{ p.included_credits|intcomma }} {% trans "advanced credits / mo" %}
                </li>

                <li class="mb-4">
                  <i class="bi bi-check-circle-fill text-success me-2"></i>
                  {{ p.max_payload_mb }} MB {% trans "max payload" %}
                </li>


                <h4>
                  Extras
                </h4>
                <li class="mb-2">
                  {% if p.has_integrations %}
                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                  {% else %}
                    <i class="bi bi-x-circle text-muted me-2"></i>
                  {% endif %}
                  {% trans "Third-party integrations" %}
                </li>
                <li class="mb-2">
                  {% if p.has_audit_logs %}
                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                  {% else %}
                    <i class="bi bi-x-circle text-muted me-2"></i>
                  {% endif %}
                  {% trans "Audit logs" %}
                </li>
              </ul>

            {% endif %}
          </div>

          <div class="mt-auto pt-3">
            {% if show_signup_buttons %}
              {% comment %}
              Marketing page - show signup buttons for anonymous users.
              Enterprise shows "Contact Sales", others show "Start free trial".
              Free plan shows "Get Started" instead of "Start free trial".
              {% endcomment %}
              {% if p.code == "ENTERPRISE" %}
                <a href="{% url 'marketing:contact' %}"
                   class="btn btn-outline-primary w-100">
                  <i class="bi bi-envelope me-1"></i>
                  {% trans "Contact Sales" %}
                </a>
              {% elif p.code == "FREE" %}
                <a href="{% url 'account_signup' %}?plan={{ p.code }}"
                   class="btn btn-success w-100">
                  {% trans "Get Started" %}
                </a>
              {% else %}
                <a href="{% url 'account_signup' %}?plan={{ p.code }}"
                   class="btn btn-success w-100">
                  {% trans "Start Free Trial" %}
                </a>
              {% endif %}

            {% elif p.code == plan.code %}
              {% comment %}
              Current plan - show manage subscription, purchase button, or current status
              {% endcomment %}
              {% if subscription.stripe_subscription_id %}
                <a href="{% url 'billing:portal' %}"
                   class="btn btn-outline-primary w-100">
                  <i class="bi bi-gear me-1"></i>
                  {% trans "Manage Subscription" %}
                </a>
              {% elif p.monthly_price_cents > 0 %}
                {% comment %}
                Paid plan without active subscription (e.g., trial expired).
                Show purchase button to let them complete payment.
                {% endcomment %}
                <form method="post" action="{% url 'billing:change-plan' %}">
                  {% csrf_token %}
                  <input type="hidden" name="plan" value="{{ p.code }}" />
                  <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-cart me-1"></i>
                    {% trans "Purchase Plan" %}
                  </button>
                </form>
              {% else %}
                {% comment %}
                Free plan - already on it, no action needed
                {% endcomment %}
                <button class="btn btn-outline-secondary w-100" disabled>
                  <i class="bi bi-check me-1"></i>
                  {% trans "Current Plan" %}
                </button>
              {% endif %}

            {% elif p.code == "ENTERPRISE" %}
              {% comment %}
              Enterprise - always contact sales
              {% endcomment %}
              <a href="{% url 'marketing:contact' %}"
                 class="btn btn-outline-primary w-100">
                <i class="bi bi-envelope me-1"></i>
                {% trans "Contact Sales" %}
              </a>

            {% elif p.code == "FREE" %}
              {% comment %}
              Free plan - downgrade via our change-plan endpoint (no Stripe needed).
              Show different confirmation message on trial expired page vs plans page.
              {% endcomment %}
              <form method="post" action="{% url 'billing:change-plan' %}">
                {% csrf_token %}
                <input type="hidden" name="plan" value="{{ p.code }}" />
                {% if show_purchase_buttons %}
                  <button type="submit"
                          class="btn btn-outline-warning w-100"
                          onclick="return confirm('{% trans "Are you sure you want to downgrade to the Free plan?" %}');">
                    <i class="bi bi-arrow-down-circle me-1"></i>
                    {% trans "Downgrade to Free" %}
                  </button>
                {% else %}
                  <button type="submit"
                          class="btn btn-outline-warning w-100"
                          onclick="return confirm('{% trans "Are you sure you want to downgrade to the Free plan? This will cancel your current subscription." %}');">
                    <i class="bi bi-arrow-down-circle me-1"></i>
                    {% trans "Downgrade to Free" %}
                  </button>
                {% endif %}
              </form>

            {% elif p.monthly_price_cents > 0 %}
              {% comment %}
              Paid plan - determine if upgrade or downgrade.
              On trial expired page (show_purchase_buttons=True), show "Purchase Plan".
              {% endcomment %}
              {% if p.monthly_price_cents > plan.monthly_price_cents %}
                {% comment %}
                Upgrade - use our change-plan endpoint
                {% endcomment %}
                <form method="post" action="{% url 'billing:change-plan' %}">
                  {% csrf_token %}
                  <input type="hidden" name="plan" value="{{ p.code }}" />
                  <button type="submit" class="btn btn-primary w-100">
                    {% if show_purchase_buttons %}
                      <i class="bi bi-cart me-1"></i>
                      {% trans "Purchase Plan" %}
                    {% else %}
                      <i class="bi bi-arrow-up-circle me-1"></i>
                      {% trans "Upgrade" %}
                    {% endif %}
                  </button>
                </form>
              {% else %}
                {% comment %}
                Downgrade to cheaper paid plan - use our change-plan endpoint
                {% endcomment %}
                <form method="post" action="{% url 'billing:change-plan' %}">
                  {% csrf_token %}
                  <input type="hidden" name="plan" value="{{ p.code }}" />
                  <button type="submit" class="btn btn-outline-secondary w-100">
                    <i class="bi bi-arrow-down-circle me-1"></i>
                    {% trans "Downgrade" %}
                  </button>
                </form>
              {% endif %}

            {% else %}
              {% comment %}
              Plan not available (no price set)
              {% endcomment %}
              <button class="btn btn-secondary w-100" disabled>
                {% trans "Coming Soon" %}
              </button>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  {% endfor %}
</div>
{% endpartialdef %}
