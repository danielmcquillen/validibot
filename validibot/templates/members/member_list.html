{% extends "app_base.html" %}

{% load i18n core_tags %}

{% block title %}
  {% trans "Members" %} · {{ organization.name }} · Validibot
{% endblock title %}
{% block left_sidebar %}
  {% include "app/partial/components/app_left_nav.html" %}
{% endblock left_sidebar %}
{% block app_content %}
  <div id="member-list"
       class="container-fluid d-flex flex-column flex-grow-1">
    <div class="app-content-header-bar row">
      <div class="app-content-header col-12 col-lg-8">
        <div class="d-flex flex-column gap-2">
          <div class="d-flex flex-wrap align-items-center gap-2">
            <h1 class="app-page-title mb-0 text-truncate">
              <i class="bi bi-people me-2"></i>{% trans "Members" %}
            </h1>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-4">
        <div class="d-flex flex-wrap gap-2 justify-content-end">
          <button type="button"
                  class="btn btn-secondary"
                  data-bs-toggle="modal"
                  data-bs-target="#memberInviteModal"
                  hx-get="{% org_url 'members:invite_form' %}"
                  hx-target="#member-invite-modal-content"
                  hx-swap="innerHTML">
            <i class="bi-person-plus me-1"></i>{% trans "Invite Member" %}
          </button>
        </div>
      </div>
    </div>
    <div class="alert alert-info mb-3" role="alert">
      {% url 'members:guest_list' as guests_url %}
      {% blocktrans %}
        <strong>About members:</strong> Members have access to your
        organization, based on the roles you give them. Members can do things like author workflows, manage
        organization settings and view analytics.
        (<a href="{{ guests_url }}">Guests</a>, on the other hand, can only access specific workflows you've shared with them.
      )
      {% endblocktrans %}
    </div>
    <div class="row flex-grow-1">
      <div class="col-12 col-lg-7">
        <div class="card app-card mb-3" id="member-list-card">
          <div class="card-header">
            <div class="card-title">
              {% trans "Current Members" %}
              <span class="badge text-bg-secondary ms-2">{{ memberships|length }}</span>
            </div>
          </div>
          <div class="card-body">{% include "members/partials/member_table.html" %}</div>
        </div>
      </div>
      <div class="col-12 col-lg-5">
        <div class="card app-card">
          <div class="card-header">
            <div class="card-title">
              {% trans "Pending Invitations" %}
              {% if pending_invites %}<span class="badge text-bg-warning ms-2">{{ pending_invites|length }}</span>{% endif %}
            </div>
          </div>
          <div class="card-body">
            {% if pending_invites %}
              <div class="list-group">
                {% for invite in pending_invites %}
                  <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                      <div class="fw-medium">
                        {% if invite.invitee_user %}
                          {{ invite.invitee_user.email }}
                        {% else %}
                          {{ invite.invitee_email }}
                        {% endif %}
                      </div>
                      <small class="text-muted">
                        {{ invite.roles|join:", " }}
                        &middot;
                        {% trans "Invited" %} {{ invite.created|date:"M j, Y" }}
                      </small>
                    </div>
                    <div class="d-flex gap-2 align-items-center">
                      <span class="badge text-bg-warning">{% trans "Pending" %}</span>
                      {% if invite.status == "PENDING" %}
                        <form method="post"
                              action="{% org_url 'members:invite_cancel' invite.id %}"
                              class="d-inline">
                          {% csrf_token %}
                          <button type="submit"
                                  class="btn btn-danger btn-sm"
                                  onclick="return confirm('{% trans "Cancel this invitation?" %}')">
                            <i class="bi-x-lg"></i>
                          </button>
                        </form>
                      {% endif %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="text-muted mb-0">{% trans "No pending invitations." %}</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock app_content %}
{% block modal %}
  {{ block.super }}
  <div class="modal fade"
       id="memberInviteModal"
       tabindex="-1"
       aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content" id="member-invite-modal-content"></div>
    </div>
  </div>
{% endblock modal %}
{% block inline_javascript %}
  {{ block.super }}
  <script>
    document.body.addEventListener('close-modal', function(event) {
      const modalEl = document.getElementById('memberInviteModal');
      if (modalEl) {
        let modal = bootstrap.Modal.getInstance(modalEl);
        if (!modal) {
          modal = new bootstrap.Modal(modalEl);
        }
        modal.hide();
      }
    });
  </script>
{% endblock inline_javascript %}
