{% load i18n core_tags %}

<div class="card app-card catalog-entries-card"
     data-sv-catalog
     data-sv-catalog-mode="{% if flat_mode %}
                             flat
                           {% else %}
                             tabs
                           {% endif %}">
  <div class="card-header">
    <div class="card-title">
      {% trans "Catalog Entries" %}
    </div>
  </div>
  <div class="card-body">
    {% if not catalog_display or not catalog_display.entries %}
      {# Hide the card entirely when no catalog signals exist #}
      <p class="text-muted mb-0">
        {% trans "No catalog entries registered yet." %}
      </p>
    {% elif flat_mode %}
      {% if catalog_display %}
        {% with prefix=catalog_tab_prefix|default:'catalog' %}
          <div class="catalog-filter mb-3 d-flex flex-row align-items-center">
            <div class="me-2">
              <label for="{{ prefix }}-flat-filter" class="small">
                {% trans "Filter:" %}
              </label>
            </div>
            <input type="search"
                   class="form-control form-control-sm"
                   id="{{ prefix }}-flat-filter"
                   placeholder="{% trans 'Filter by signal name' %}"
                   data-sv-catalog-filter
                   data-sv-catalog-filter-target="#{{ prefix }}-flat-panel" />
          </div>
          <div id="{{ prefix }}-flat-panel" data-sv-catalog-panel>
            <div class="table-responsive">
              <table class="table table-sm align-middle" data-sortable-table>
                <thead>
                  <tr>
                    <th class="text-muted small" data-sortable="true">{% trans "Target path" %}</th>
                    <th class="text-muted small" data-sortable="true">{% trans "Type" %}</th>
                    <th class="text-muted small" data-sortable="true">{% trans "Stage" %}</th>
                  </tr>
                </thead>
                <tbody>
                  {% for entry in catalog_display.entries %}
                    <tr data-sv-catalog-entry
                        data-sv-catalog-label="{{ entry.label|default:entry.slug|escape }}"
                        data-sv-catalog-slug="{{ entry.slug|escape }}">
                      <td>
                        <code class="catalog-entry-slug d-inline-block text-truncate"
                              data-original-text="{{ entry.target_field|escape }}"
                              style="max-width: 220px;"
                              title="{{ entry.target_field }}">{{ entry.target_field }}</code>
                      </td>
                      <td class="text-muted small" data-sort-value="{{ entry.entry_type }}">
                        {{ entry.get_entry_type_display }}
                      </td>
                      <td class="text-muted small" data-sort-value="{{ entry.run_stage }}">
                        {{ entry.get_run_stage_display }}
                      </td>
                    </tr>
                  {% endfor %}
                  {% if not catalog_display.entries %}
                    <tr data-sv-catalog-entry>
                      <td colspan="3" class="text-muted small">
                        {% trans "No catalog entries registered yet." %}
                      </td>
                    </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
            <p class="text-muted small d-none" data-sv-catalog-empty>
              {% trans "No entries match your filter." %}
            </p>
          </div>
        {% endwith %}
      {% else %}
        <p class="text-muted mb-0">
          {% trans "No catalog entries registered yet." %}
        </p>
      {% endif %}
    {% elif catalog_display and catalog_display.uses_tabs %}
      <div class="tabs">
        <div class="nav nav-tabs validator-library-tabs" role="tablist">
          <button class="nav-link active"
                  id="{{ catalog_tab_prefix|default:'catalog' }}-input-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#{{ catalog_tab_prefix|default:'catalog' }}-input-panel"
                  type="button"
                  role="tab"
                  aria-controls="{{ catalog_tab_prefix|default:'catalog' }}-input-panel"
                  aria-selected="true">
            <span class="fw-semibold">{% trans "Inputs" %}</span>
            <span class="badge text-bg-light ms-2">
              {{ catalog_display.input_total }}
            </span>
          </button>
          <button class="nav-link"
                  id="{{ catalog_tab_prefix|default:'catalog' }}-output-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#{{ catalog_tab_prefix|default:'catalog' }}-output-panel"
                  type="button"
                  role="tab"
                  aria-controls="{{ catalog_tab_prefix|default:'catalog' }}-output-panel"
                  aria-selected="false">
            <span class="fw-semibold">{% trans "Outputs" %}</span>
            <span class="badge text-bg-light ms-2">
              {{ catalog_display.output_total }}
            </span>
          </button>
        </div>
      </div>
      <div class="tab-content">
        <div class="tab-pane fade show active p-3"
             id="{{ catalog_tab_prefix|default:'catalog' }}-input-panel"
             role="tabpanel"
             aria-labelledby="{{ catalog_tab_prefix|default:'catalog' }}-input-tab"
             data-sv-catalog-panel>
          <div class="catalog-filter mb-3">
            <label for="{{ catalog_tab_prefix|default:'catalog' }}-input-filter"
                   class="form-label small">
              {% trans "Filter entries" %}
            </label>
            <input type="search"
                   class="form-control form-control-sm"
                   id="{{ catalog_tab_prefix|default:'catalog' }}-input-filter"
                   placeholder="{% trans 'Filter by signal name' %}"
                   data-sv-catalog-filter
                   data-sv-catalog-filter-target="#{{ catalog_tab_prefix|default:'catalog' }}-input-panel" />
          </div>
          {% if catalog_display.inputs or catalog_display.input_derivations %}
            {% if catalog_display.inputs %}
              {% include 'validations/library/partials/catalog_entry_list.html' with entries=catalog_display.inputs %}
            {% endif %}
            {% if catalog_display.input_derivations %}
              {% include 'validations/library/partials/catalog_entry_list.html' with entries=catalog_display.input_derivations %}
            {% endif %}
          {% else %}
            <p class="text-muted mb-0">
              {% trans "No entries." %}
            </p>
          {% endif %}
          <p class="text-muted small d-none" data-sv-catalog-empty>
            {% trans "No entries match your filter." %}
          </p>
        </div>
        <div class="tab-pane fade p-3"
             id="{{ catalog_tab_prefix|default:'catalog' }}-output-panel"
             role="tabpanel"
             aria-labelledby="{{ catalog_tab_prefix|default:'catalog' }}-output-tab"
             data-sv-catalog-panel>
          <div class="catalog-filter mb-3">
            <label for="{{ catalog_tab_prefix|default:'catalog' }}-output-filter"
                   class="form-label small">
              {% trans "Filter entries" %}
            </label>
            <input type="search"
                   class="form-control form-control-sm"
                   id="{{ catalog_tab_prefix|default:'catalog' }}-output-filter"
                   placeholder="{% trans 'Filter by signal name' %}"
                   data-sv-catalog-filter
                   data-sv-catalog-filter-target="#{{ catalog_tab_prefix|default:'catalog' }}-output-panel" />
          </div>
          {% if catalog_display.outputs or catalog_display.output_derivations %}
            {% if catalog_display.outputs %}
              {% include 'validations/library/partials/catalog_entry_list.html' with entries=catalog_display.outputs %}
            {% endif %}
            {% if catalog_display.output_derivations %}
              {% include 'validations/library/partials/catalog_entry_list.html' with entries=catalog_display.output_derivations %}
            {% endif %}
          {% else %}
            <p class="text-muted mb-0">
              {% trans "No entries." %}
            </p>
          {% endif %}
          <p class="text-muted small d-none" data-sv-catalog-empty>
            {% trans "No entries match your filter." %}
          </p>
        </div>
      </div>
    {% elif catalog_display and catalog_display.entries %}
      {% include 'validations/library/partials/catalog_entry_list.html' with entries=catalog_display.entries %}
    {% else %}
      <p class="text-muted mb-0">
        {% trans "No catalog entries registered yet." %}
      </p>
    {% endif %}
  </div>
</div>
