{% load i18n %}

<div class="modal fade"
     id="validatorCreateModal"
     tabindex="-1"
     aria-labelledby="validator-create-modal-title"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg modal-step-selector-dialog">
    <div class="modal-content" id="validator-create-modal-content">
      <div class="modal-header">
        <div>
          <h5 class="modal-title" id="validator-create-modal-title">
            {% trans "Create validator" %}
          </h5>
          <p class="text-muted small mb-0">
            {% trans "Select the type of validator you want to build." %}
          </p>
        </div>
        <button type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="{% trans 'Close' %}">
        </button>
      </div>
      <div class="modal-body p-0">
        {% if validator_create_options %}
          <form class="d-flex flex-column h-100" id="validator-create-form">
            <div class="card shadow-sm flex-grow-1 d-flex flex-column mb-0">
              <div class="card-body d-flex flex-column">
                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4 align-items-stretch">
                  {% for option in validator_create_options %}
                    {% with input_id='validator-create-option-'|add:option.value|slugify %}
                      <div class="col">
                        <input class="btn-check step-option validator-create-option"
                               type="radio"
                               name="validator_type"
                               id="{{ input_id }}"
                               value="{{ option.value }}"
                               data-create-url="{{ option.url }}"
                               {% if validator_create_selected and validator_create_selected == option.value %}
                                 checked
                               {% elif not validator_create_selected and forloop.first %}
                                 checked
                               {% endif %}
                               autocomplete="off"
                               required />
                        <label class="validator-card h-100
                                      {% if validator_create_selected and validator_create_selected == option.value %}
                                        is-selected
                                      {% elif not validator_create_selected and forloop.first %}
                                        is-selected
                                      {% endif %}"
                               for="{{ input_id }}">
                          <div class="validator-card__icon mb-3">
                            <i class="bi {{ option.icon }}"></i>
                          </div>
                          <div class="validator-card__title mb-1">
                            {{ option.name }}
                          </div>
                          {% if option.subtitle %}
                            <div class="validator-card__subtitle text-uppercase">
                              {{ option.subtitle }}
                            </div>
                          {% endif %}
                          {% if option.description %}
                            <p class="validator-card__description small mb-0 mt-2">
                              {{ option.description }}
                            </p>
                          {% endif %}
                        </label>
                      </div>
                    {% endwith %}
                  {% endfor %}
                </div>
              </div>
              <div class="card-footer bg-body-tertiary d-flex justify-content-end gap-2">
                <button type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal">
                  {% trans "Cancel" %}
                </button>
                <button type="submit" class="btn btn-secondary">
                  {% trans "Create" %}
                </button>
              </div>
            </div>
          </form>
        {% else %}
          <div class="p-4">
            <div class="alert alert-info mb-0" role="alert">
              {% trans "No validator types are available yet." %}
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
<script>
  (function() {
    const modalContent = document.getElementById('validator-create-modal-content');
    if (!modalContent) {
      return;
    }

    const toggleSelection = (selectedInput) => {
      modalContent.querySelectorAll('.validator-card').forEach((card) => {
        card.classList.remove('is-selected');
      });
      if (!selectedInput) {
        return;
      }
      const label = modalContent.querySelector(`label[for="${selectedInput.id}"]`);
      if (label) {
        label.classList.add('is-selected');
      }
    };

    const optionInputs = modalContent.querySelectorAll('.validator-create-option');
    optionInputs.forEach((input) => {
      if (input.checked) {
        toggleSelection(input);
      }
      input.addEventListener('change', (event) => {
        if (event.currentTarget.checked) {
          toggleSelection(event.currentTarget);
        }
      });
    });

    const form = modalContent.querySelector('#validator-create-form');
    if (form) {
      form.addEventListener('submit', (event) => {
        event.preventDefault();
        const selected = modalContent.querySelector(
          '.validator-create-option:checked',
        );
        if (!selected) {
          return;
        }
        const targetUrl = selected.dataset.createUrl;
        if (targetUrl) {
          window.location.href = targetUrl;
        }
      });
    }
  })();
</script>
