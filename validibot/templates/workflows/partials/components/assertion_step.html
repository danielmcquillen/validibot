{% load i18n core_tags %}

<div class="assertion-step-wrapper"
     id="assertion-card-{{ assertion.id }}"
     data-step-id="{{ step.id }}"
     data-assertion-id="{{ assertion.id }}"
     data-run-stage="{{ run_stage|default:assertion.resolved_run_stage }}">
    <div class="assertion-card card shadow-sm">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                <div>
                    <div class="d-flex align-items-center gap-2 mb-1">
                        <span class="badge text-bg-light text-uppercase">{{ assertion.get_assertion_type_display }}</span>
                        <span class="badge text-bg-secondary">{{ assertion.get_severity_display }}</span>
                    </div>
                    <h2 class="h6 mb-1">
                        {{ assertion.target_display }}
                    </h2>
                    <p class="text-muted small mb-1">
                        {{ assertion.condition_display }}
                    </p>
                    {% if assertion.message_template %}
                        <p class="text-muted small mb-0">
                            {{ assertion.message_template|linebreaksbr }}
                        </p>
                    {% endif %}
                </div>
                {% if can_manage_assertions %}
                    <div class="btn-group btn-group-sm assertion-actions"
                         role="group"
                         aria-label="{% trans 'Assertion actions' %}">
                        <button type="button"
                                class="btn btn-secondary"
                                data-bs-toggle="modal"
                                data-bs-target="#workflowAssertionModal"
                                hx-get="{% org_url 'workflows:workflow_step_assertion_update' workflow.pk step.pk assertion.pk %}"
                                hx-target="#workflow-assertion-modal-content"
                                hx-trigger="click">
                            <i class="bi-pencil-square"></i>
                            <span class="visually-hidden">{% trans "Edit assertion" %}</span>
                        </button>
                        <button class="btn btn-secondary"
                                hx-post="{% org_url 'workflows:workflow_step_assertion_move' workflow.pk step.pk assertion.pk %}"
                                hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                                hx-vals='{"direction": "up"}'
                                hx-target="this"
                                hx-swap="none"
                                {% if forloop.first %}disabled{% endif %}>
                            <i class="bi-arrow-up"></i>
                            <span class="visually-hidden">{% trans "Move assertion up" %}</span>
                        </button>
                        <button class="btn btn-secondary"
                                hx-post="{% org_url 'workflows:workflow_step_assertion_move' workflow.pk step.pk assertion.pk %}"
                                hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                                hx-vals='{"direction": "down"}'
                                hx-target="this"
                                hx-swap="none"
                                {% if forloop.last %}disabled{% endif %}>
                            <i class="bi-arrow-down"></i>
                            <span class="visually-hidden">{% trans "Move assertion down" %}</span>
                        </button>
                        <button class="btn btn-danger"
                                hx-post="{% org_url 'workflows:workflow_step_assertion_delete' workflow.pk step.pk assertion.pk %}"
                                hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                                hx-confirm="{% trans 'Delete this assertion?' %}"
                                hx-target="this"
                                hx-swap="none">
                            <i class="bi-trash"></i>
                            <span class="visually-hidden">{% trans "Delete assertion" %}</span>
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
