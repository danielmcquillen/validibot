{% load i18n %}
<div class="public-step-item">
    <div class="public-step-card">
        <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
            <span class="badge text-bg-primary badge-step-index">{% trans "Step" %} {{ forloop.counter }}</span>
            <h3 class="h6 mb-0">
                {% if step.name %}
                    {{ step.name }}
                {% elif step.validator %}
                    {{ step.validator.name }}
                {% elif step.action %}
                    {{ step.action.name }}
                {% else %}
                    {% trans "Workflow step" %}
                {% endif %}
            </h3>
            {% if step.validator %}
                <span class="badge text-bg-light text-uppercase small">
                    {{ step.validator.get_validation_type_display }}
                </span>
            {% elif step.public_action_meta %}
                <span class="badge text-bg-light text-uppercase small">
                    {{ step.public_action_meta.category_label }}
                </span>
            {% endif %}
        </div>
        {% if step.description %}
            <p class="text-muted mb-3">
                {{ step.description|linebreaksbr }}
            </p>
        {% endif %}
        {% comment %}
                          <div class="text-muted small">
                            <span>{% trans "Validator" %}: {{ step.validator.name }}</span>
                            {% if step.ruleset %}
                              Â· <span>{% trans "Ruleset" %}: {{ step.ruleset.name }}</span>
                            {% endif %}
                          </div>
        {% endcomment %}
        {% if step.public_schema %}
            <div class="mt-3">
                <button class="btn btn-sm btn-outline-secondary"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#schema-detail-{{ step.id }}"
                        aria-expanded="false"
                        aria-controls="schema-detail-{{ step.id }}">
                    {% trans "Show schema" %}
                </button>
                <div class="collapse mt-3" id="schema-detail-{{ step.id }}">
                    <pre class="bg-body-tertiary p-3 rounded overflow-auto">
<code class="language-{{ step.public_schema.language|default:'text' }}">{{ step.public_schema.content|escape }}</code>
                    </pre>
                </div>
            </div>
        {% elif step.public_action_meta %}
            <div class="mt-3">
                <div class="text-muted small">
                    <i class="bi {{ step.public_action_meta.icon|default:'bi-gear' }} me-1"></i>
                    {{ step.public_action_meta.definition_name }}
                </div>
                {% if step.public_action_summary.message %}
                    <p class="text-muted small mt-2 mb-0">
                        <span class="fw-semibold">{% trans "Message" %}:</span><br>
                        {{ step.public_action_summary.message|linebreaksbr }}
                    </p>
                {% endif %}
                {% if step.public_action_summary.certificate_template %}
                    <p class="text-muted small mt-2 mb-0">
                        <span class="fw-semibold">{% trans "Certificate template" %}:</span>
                        <code class="text-break">{{ step.public_action_summary.certificate_template }}</code>
                    </p>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>
{% if not forloop.last and steps|length > 1 %}
    <div class="workflow-step-connector" aria-hidden="true">
        <div class="workflow-step-arrow">
        </div>
    </div>
{% endif %}
