{% load i18n core_tags %}

<div class="card app-card mb-3" id="guest-access-section">
  <div class="card-header">
    <div class="card-title">
      {% trans "Guest Access" %}
      <span class="badge text-bg-secondary ms-2">{{ access_grants|length }}</span>
    </div>
  </div>
  <div class="card-body">
    {% if access_grants %}
      <p class="text-muted small mb-3">
        {% trans "People with access to this workflow:" %}
      </p>
      <div class="list-group mb-3">
        {% for grant in access_grants %}
          <div class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <span class="fw-medium">
                {{ grant.user.email }}
              </span>
              {% if grant.user.name %}
                <span class="text-muted small ms-2">({{ grant.user.name }})</span>
              {% endif %}
              <br />
              <small class="text-muted">
                {% trans "Added" %} {{ grant.created|date:"M j, Y" }}
                {% if grant.granted_by %}
                  {% blocktrans with name=grant.granted_by.name|default:grant.granted_by.email %}by {{ name }}{% endblocktrans %}
                {% endif %}
              </small>
            </div>
            {% if can_manage_sharing %}
              <button type="button"
                      class="btn btn-outline-danger btn-sm"
                      hx-post="{% org_url 'workflows:workflow_guest_revoke' pk=workflow.pk grant_id=grant.pk %}"
                      hx-target="#guest-access-section"
                      hx-swap="outerHTML"
                      hx-confirm="{% trans 'Remove access for this user?' %}">
                <i class="bi-x-lg"></i> {% trans "Remove" %}
              </button>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted mb-3">
        {% trans "No guests have been granted access to this workflow yet." %}
      </p>
    {% endif %}

    {# Pending Invitations #}
    {% if pending_invites %}
      <p class="text-muted small mb-2">
        {% trans "Pending invitations:" %}
        <span class="badge text-bg-warning">{{ pending_invites|length }}</span>
      </p>
      <div class="list-group mb-3">
        {% for invite in pending_invites %}
          <div class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <span class="fw-medium">
                {{ invite.invitee_email|default:invite.invitee_user.email }}
              </span>
              <br />
              <small class="text-muted">
                {% trans "Invited" %} {{ invite.created|date:"M j, Y" }}
                {% if invite.expires_at %}
                  &middot; {% trans "Expires" %} {{ invite.expires_at|date:"M j, Y" }}
                {% endif %}
              </small>
            </div>
            <div class="d-flex gap-2 align-items-center">
              <span class="badge text-bg-warning">{% trans "Pending" %}</span>
              {% if can_manage_sharing %}
                <button type="button"
                        class="btn btn-outline-secondary btn-sm"
                        hx-post="{% org_url 'workflows:workflow_invite_resend' pk=workflow.pk invite_id=invite.pk %}"
                        hx-target="#guest-access-section"
                        hx-swap="outerHTML"
                        title="{% trans 'Resend invitation' %}">
                  <i class="bi-arrow-repeat"></i>
                </button>
                <button type="button"
                        class="btn btn-outline-danger btn-sm"
                        hx-post="{% org_url 'workflows:workflow_invite_cancel' pk=workflow.pk invite_id=invite.pk %}"
                        hx-target="#guest-access-section"
                        hx-swap="outerHTML"
                        hx-confirm="{% trans 'Cancel this invitation?' %}"
                        title="{% trans 'Cancel invitation' %}">
                  <i class="bi-x-lg"></i>
                </button>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    {% if can_manage_sharing %}
      <div class="mt-3">
        <button type="button"
                class="btn btn-primary btn-sm"
                data-bs-toggle="modal"
                data-bs-target="#guestInviteModal"
                hx-get="{% org_url 'workflows:workflow_guest_invite' pk=workflow.pk %}"
                hx-target="#guest-invite-modal-content"
                hx-swap="innerHTML">
          <i class="bi-person-plus me-1"></i>{% trans "Invite Guest" %}
        </button>
      </div>
    {% endif %}
  </div>
</div>
