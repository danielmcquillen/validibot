{% extends "core/base.html" %}

{% load i18n %}

{% block page_title %}
  {% trans "All Workflows" %}
{% endblock page_title %}

{% block content %}
  <section class="py-4 py-lg-5">
    <div class="container-fluid">

      <div class="row mb-4">
        <div class="col-12 col-lg-10 col-xl-8">
          <header>
            <h1>
              {% trans "All Workflows" %}
            </h1>
          </header>
        </div>
      </div>

      <div class="row">
        <div class="col-12 col-lg-10">
          <form method="get" class="mb-4">
            <input type="hidden" name="layout" value="{{ current_layout }}" />
            <input type="hidden" name="per_page" value="{{ current_page_size }}" />
            <div class="row g-3 align-items-center">
              <div class="col-12 col-lg-6">
                <label class="form-label text-muted small text-uppercase mb-1"
                       for="workflow-search">
                  {% trans "Search workflows" %}
                </label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="bi bi-search"></i>
                  </span>
                  <input id="workflow-search"
                         type="search"
                         name="q"
                         value="{{ search_query }}"
                         class="form-control"
                         placeholder="{% trans 'Search by name or slug' %}" />
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="col-12 col-lg-2 d-flex flex-column justify-content-end">
          <div class="d-flex flex-row justify-content-end mb-4">
            <div class="btn-group"
                 role="group"
                 data-bs-toggle="tooltip"
                 data-bs-placement="top"
                 title="{% trans 'Grid view' %}"
                 aria-label="{% trans 'Workflow layout toggle' %}">
              <a href="{{ layout_urls.grid }}"
                 class="btn
                        {% if current_layout == 'grid' %}
                          btn-secondary
                        {% else %}
                          btn-secondary
                        {% endif %}">
                <i class="bi bi-grid-3x3-gap-fill me-1"></i>
                {# % trans "Grid" % #}
              </a>
              <a href="{{ layout_urls.list }}"
                 data-bs-toggle="tooltip"
                 data-bs-placement="top"
                 title="{% trans 'List view' %}"
                 class="btn
                        {% if current_layout == 'list' %}
                          btn-secondary
                        {% else %}
                          btn-secondary
                        {% endif %}">
                <i class="bi bi-view-list me-1"></i>
                {#  % trans "List" % #}
              </a>
            </div>
          </div>
        </div>
      </div>


      {% if workflows %}
        {% if current_layout == "grid" %}
          <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4">
            {% for workflow in workflows %}
              <div class="col">
                <div class="card h-100 shadow-sm">
                  <div class="card-body d-flex flex-column gap-2">
                    <div class="d-flex align-items-start justify-content-between ">
                      <div>
                        <h2 class="h5 mb-1">
                          <a href="{% url 'workflow_public_info' workflow_uuid=workflow.uuid %}"
                             class="stretched-link text-decoration-none">
                            {{ workflow.name }}
                          </a>
                        </h2>
                        <div class="text-muted small">
                          {% if workflow.project %}
                            {{ workflow.project.name }}
                          {% else %}
                            {% trans "Ungrouped" %}
                          {% endif %}
                          · {{ workflow.org.name }}
                        </div>
                      </div>
                    </div>
                    {% with total_steps=workflow.steps.all|length %}
                      <div class="text-muted small">
                        {% blocktrans count total=total_steps %}
                          {{ total }} validation step
                        {% plural %}
                          {{ total }} validation steps
                        {% endblocktrans %}
                      </div>
                    {% endwith %}
                  </div>
                  <div class="card-footer bg-white border-top-0 pt-0">
                    <div class="d-flex justify-content-between align-items-center text-muted small">
                      <span>
                        {% trans "Updated" %} {{ workflow.modified|date:"M j, Y" }}
                      </span>
                      {% if workflow.make_info_page_public %}
                        <span class="badge text-bg-light">
                          {% trans "Public" %}
                        </span>
                      {% else %}
                        <span class="badge text-bg-secondary">
                          {% trans "Member access" %}
                        </span>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="vstack gap-3">
            {% for workflow in workflows %}
              <div class="card shadow-sm">
                <div class="card-body">
                  <div class="d-flex flex-column flex-md-row justify-content-between gap-3">
                    <div>
                      <h2 class="h5 mb-1">
                        <a href="{% url 'workflow_public_info' workflow_uuid=workflow.uuid %}"
                           class="stretched-link text-decoration-none">
                          {{ workflow.name }}
                        </a>
                      </h2>
                      <div class="text-muted small mb-2">
                        {% if workflow.project %}
                          {{ workflow.project.name }}
                        {% else %}
                          {% trans "Ungrouped" %}
                        {% endif %}
                        · {{ workflow.org.name }}
                      </div>
                      {% with total_steps=workflow.steps.all|length %}
                        <div class="text-muted small">
                          {% blocktrans count total=total_steps %}
                            {{ total }} validation step
                          {% plural %}
                            {{ total }} validation steps
                          {% endblocktrans %}
                        </div>
                      {% endwith %}
                    </div>
                    <div class="text-muted text-md-end small">
                      <div>
                        {% trans "Updated" %} {{ workflow.modified|date:"M j, Y" }}
                      </div>
                      {% if workflow.make_info_page_public %}
                        <span class="badge text-bg-light mt-2">
                          {% trans "Public" %}
                        </span>
                      {% else %}
                        <span class="badge text-bg-secondary mt-2">
                          {% trans "Member access" %}
                        </span>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% else %}
        <div class="alert alert-info" role="status">
          {% if search_query %}
            {% blocktrans with query=search_query %}
              No workflows match "{{ query }}". Try a different search.
            {% endblocktrans %}
          {% else %}
            {% trans "No workflows are available yet." %}
          {% endif %}
        </div>
      {% endif %}

      {% if page_obj %}
        <div class="mt-4">
          {% include "core/partial/pagination.html" with page_obj=page_obj query_string=query_string page_size_options=page_size_options current_page_size=current_page_size %}
        </div>
      {% endif %}
    </div>
  </section>
{% endblock content %}
