{% extends "app_base.html" %}

{% load i18n core_tags %}

{% block title %}
  {{ workflow.name }} · {% trans "Workflows" %} · Validibot
{% endblock title %}
{% block left_sidebar %}
  {% include "app/partial/components/app_left_nav.html" %}
{% endblock left_sidebar %}
{% block app_content %}
  <div id="workflow-detail"
       class="container-fluid d-flex flex-column flex-grow-1">
    <div class="app-content-header-bar row ">
      <div class="app-content-header col-12 col-lg-8">
        <div class="d-flex flex-column gap-2">
          <div class="d-flex flex-wrap align-items-center gap-2">
            <h1 class="app-page-title mb-0 text-truncate">
              <i class="bi bi-box me-2"></i>Workflow: {{ workflow.name }}
              {% if workflow.version %}
                <span class="text-muted xs-small ms-2">( {% trans "Version" %} {{ workflow.version }} )</span>
              {% endif %}
            </h1>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-4 ">
        <div class="d-flex flex-wrap gap-2 justify-content-end">
          {# link to launch #}
          {% if can_launch_workflow %}
            <a class="btn btn-success bg-success-subtle"
               data-bs-toggle="tooltip"
               data-bs-placement="top"
               title="{% trans "Start a new validation run with this workflow" %}"
               href="{% url 'workflows:workflow_launch' workflow.pk %}">
              <i class="bi-rocket me-1"></i>{% trans "Launch" %}
            </a>
          {% endif %}
          {% if can_manage_workflow %}
            <a class="btn btn-secondary"
               data-bs-toggle="tooltip"
               data-bs-placement="top"
               title="{% trans "Sharing settings" %}"
               href="{% org_url 'workflows:workflow_sharing' pk=workflow.pk %}">
              <i class="bi-share"></i>
            </a>
            <a class="btn btn-secondary"
               data-bs-toggle="tooltip"
               data-bs-placement="top"
               title="{% trans "View Validations" %}"
               href="{{ related_validations_url }}">
              <i class="bi-diagram-3"></i>
            </a>
            <a class="btn btn-danger"
               hx-delete="{% url 'workflows:workflow_delete' workflow.pk %}"
               hx-target="body"
               data-bs-toggle="tooltip"
               data-bs-placement="top"
               title="{% trans "Delete this workflow" %}"
               hx-confirm="{% trans "Delete this workflow?" %}">
              <i class="bi-trash"></i>
            </a>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="row workflow-detail-layout flex-grow-1 align-items-stretch">
      <div class="col-12 col-lg-6 col-xxl-8 d-flex flex-column">
        <div class="card app-card" id="workflow-step-editor-card">
          <div class="card-header">
            <div class="card-title">
              <span class="fw-semibold">{% trans "Workflow steps" %}</span>
              <span class="text-muted small ms-2">{% trans "Design the sequence of validations and actions." %}</span>
            </div>
            <div class="card-header-buttons">
              {% if can_manage_workflow %}
                <button class="btn btn-secondary btn-sm"
                        data-bs-toggle="modal"
                        data-bs-target="#workflowStepModal"
                        hx-get="{% url 'workflows:workflow_step_wizard' workflow.pk %}"
                        hx-target="#workflow-step-modal-content"
                        hx-swap="innerHTML">
                  <i class="bi-plus-lg me-1"></i>{% trans "Add step" %}
                </button>
              {% endif %}
            </div>
          </div>
          <div class="card-body editor-workspace d-flex flex-column flex-grow-1">
            <div id="steps-list"
                 class="flex-grow-1"
                 hx-get="{% url 'workflows:workflow_step_list' workflow.pk %}"
                 hx-trigger="load, steps-changed from:body"
                 hx-target="this"
                 hx-swap="innerHTML">
              {% include "workflows/partials/workflow_step_list.html" with workflow=workflow steps=workflow.steps.all max_step_count=max_step_count show_private_notes=show_private_notes %}
            </div>
          </div>
        </div>
      </div>
      <div id="workflow-steps-col"
           class="col-12 col-lg-6 col-xxl-4 d-flex flex-column">
        <div class="card app-card mb-3">
          <div class="card-header">
            <div class="card-heaer-title">
              <span class="fw-semibold">{% trans "Workflow details" %}</span>
              {% if workflow.is_locked %}
                <span class="badge text-bg-warning">{% trans "Locked" %}</span>
              {% endif %}
            </div>
            <div class="card-header-buttons">
              {% if can_manage_workflow %}
                <a class="btn btn-sm btn-secondary ms-2"
                   href="{% org_url 'workflows:workflow_update' pk=workflow.pk %}"
                   aria-label="{% trans "Edit workflow details" %}"
                   data-bs-toggle="tooltip"
                   data-bs-placement="top"
                   title="{% trans "Workflow settings" %}">
                  <i class="bi bi-gear-fill"></i>
                </a>
              {% endif %}
            </div>
          </div>
          {% if workflow.has_featured_image %}
            <img src="{{ workflow.get_featured_image_url }}"
                 class="object-fit-cover w-100 h-100c"
                 alt="{% blocktrans with name=workflow.name %} Image for workflow {{ name }} {% endblocktrans %}" />
          {% endif %}
          <div class="card-body">
            <dl class="row mb-0">
              <dt class="col-sm-4">{% trans "Name" %}</dt>
              <dd class="col-sm-8">
                {{ workflow.name }}
              </dd>
              <dt class="col-sm-4">{% trans "Status" %}</dt>
              <dd class="col-sm-8">
                <div class="d-flex flex-column gap-2">
                  <div>
                    <div class="d-flex flex-row gap-2 align-items-center">
                      {% if workflow.is_active %}
                        <div class="badge text-bg-primary py-2">{% trans "Active" %}</div>
                      {% else %}
                        <div class="badge text-bg-dark py-2">{% trans "Inactive" %}</div>
                      {% endif %}
                      {% if can_manage_activation %}
                        <form method="post"
                              action="{% org_url 'workflows:workflow_activation' pk=workflow.pk %}">
                          {% csrf_token %}
                          {% if workflow.is_active %}
                            <input type="hidden" name="is_active" value="false" />
                            <button type="submit"
                                    data-bs-toggle="tooltip"
                                    data-bs-placement="top"
                                    title="{% trans 'Disable workflow' %}"
                                    class="btn btn-warning btn-sm">
                              <i class="bi-pause-circle"></i>
                            </button>
                          {% else %}
                            <input type="hidden" name="is_active" value="true" />
                            <button type="submit"
                                    data-bs-toggle="tooltip"
                                    data-bs-placement="top"
                                    title="{% trans 'Enable workflow' %}"
                                    class="btn btn-success btn-sm">
                              <i class="bi-play-circle me"></i>
                            </button>
                          {% endif %}
                        </form>
                      {% endif %}
                    </div>
                  </div>
                  <small class="text-muted mb-2">
                    {% trans "Inactive workflows stay visible in the catalog but block new validation runs." %}
                  </small>
                </div>
              </dd>
              <dt class="col-sm-4">{% trans "Slug" %}</dt>
              <dd class="col-sm-8">
                {{ workflow.slug }}
              </dd>
              <dt class="col-sm-4">{% trans "Version" %}</dt>
              <dd class="col-sm-8">
                <span class="text-muted">{{ workflow.version|default:_("not set") }}</span>
              </dd>
              <dt class="col-sm-4">{% trans "File types" %}</dt>
              <dd class="col-sm-8">
                {{ workflow.allowed_file_type_labels|join:", " }}
              </dd>
              <dt class="col-sm-4">{% trans "Created" %}</dt>
              <dd class="col-sm-8">
                {{ workflow.created|date:"M j, Y g:i a" }}
              </dd>
              {% comment %}
              <dt class="col-sm-4">
                {% trans "Updated" %}
              </dt>
              <dd class="col-sm-8">
                {{ workflow.modified|date:"M j, Y g:i a" }}
              </dd>
              {% endcomment %}
              <dt class="col-sm-4">{% trans "Created by" %}</dt>
              <dd class="col-sm-8">
                {{ workflow.user.name|default:workflow.user.username }}
              </dd>
            </dl>
          </div>
        </div>
        {% include "workflows/partials/workflow_public_info_card.html" with workflow=workflow public_info_url=public_info_url can_manage_public_info=can_manage_public_info %}
        <div class="card app-card mb-3">
          <div class="card-header">
            <div class="card-title">{% trans "API access" %}</div>
          </div>
          <div class="card-body bg-body-tertiary">
            <div class="d-flex align-items-center gap-2 mb-3">
              <div>
                <div class="fw-semibold mb-0">{% trans "Start this workflow via API" %}</div>
                <small class="text-muted">{% trans "POST requests launch a validation run for this workflow." %}</small>
              </div>
            </div>
            <ul class="list-unstyled small text-muted mb-3">
              <li>
                <span class="fw-semibold me-1">{% trans "Endpoint" %}:</span>
                <code class="text-body-secondary">POST /api/v1/orgs/{{ workflow.org.slug }}/workflows/{{ workflow.slug|default:workflow.pk }}/runs/</code>
              </li>
              <li>
                <span class="fw-semibold me-1">{% trans "Auth" %}:</span>
                {% blocktrans with org_name=workflow.org.name %}Bearer token with the Executor role in {{ org_name }}.{% endblocktrans %}
              </li>
              <li>
                <span class="fw-semibold me-1">{% trans "Content" %}:</span>
                {% trans "Send raw content, a JSON envelope, or multipart form-data." %}
              </li>
            </ul>
            <pre class="bg-dark text-white rounded-3 p-3 small mb-2"><code>curl -X POST https://{{ request.get_host|default:"api.validibot.io" }}/api/v1/orgs/{{ workflow.org.slug }}/workflows/{{ workflow.slug|default:workflow.pk }}/runs/ \
  -H "Authorization: Bearer &lt;token&gt;" \
  -H "Content-Type: application/json" \
  -d '{
    "content": "{ \"example\": true }",
    "content_type": "application/json",
    "filename": "sample.json"
  }'</code></pre>
            <p class="small text-muted mb-0">
              {% trans "See the developer guide 'Using a Workflow via the API' for additional payload examples." %}
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock app_content %}
{% block modal %}
  {{ block.super }}
  <div class="modal fade"
       id="workflowStepModal"
       tabindex="-1"
       aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl modal-step-selector-dialog">
      <div class="modal-content" id="workflow-step-modal-content"></div>
    </div>
  </div>
{% endblock modal %}
{% block inline_javascript %}
  {{ block.super }}
  <script>
    document.body.addEventListener('close-modal', function(event) {
      const detail = event?.detail;
      const targetId =
        (typeof detail === 'string' && detail) ||
        detail?.value ||
        detail?.['close-modal'] ||
        'workflowStepModal';
      if (!targetId) {
        return;
      }
      const modalEl = document.getElementById(targetId);
      if (!modalEl) {
        return;
      }
      let modal = bootstrap.Modal.getInstance(modalEl);
      if (!modal) {
        modal = new bootstrap.Modal(modalEl);
      }
      modal.hide();
    });
  </script>
{% endblock inline_javascript %}
