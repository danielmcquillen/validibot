{% extends "app_base.html" %}

{% load i18n core_tags %}

{% block title %}
  {% trans "Sharing" %} 路 {{ workflow.name }} 路 {% trans "Workflows" %} 路 Validibot
{% endblock title %}

{% block left_sidebar %}
  {% include "app/partial/components/app_left_nav.html" %}
{% endblock left_sidebar %}

{% block app_content %}
  <div class="container-fluid d-flex flex-column flex-grow-1">
    <div class="app-content-header-bar row">
      <div class="app-content-header col-12 col-lg-8">
        <div class="d-flex flex-column gap-2">
          <div class="d-flex flex-wrap align-items-center gap-2">
            <h1 class="app-page-title mb-0 text-truncate">
              <i class="bi bi-share me-2"></i>{% trans "Sharing" %}: {{ workflow.name }}
            </h1>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-4">
        <div class="d-flex flex-wrap gap-2 justify-content-end">
          <a class="btn btn-outline-secondary"
             href="{% org_url 'workflows:workflow_detail' pk=workflow.pk %}">
            <i class="bi-arrow-left me-1"></i>{% trans "Back to Workflow" %}
          </a>
        </div>
      </div>
    </div>

    <div class="row flex-grow-1">
      <div class="col-12 col-lg-8">
        {# Visibility Section #}
        {% include "workflows/partials/workflow_visibility_section.html" %}

        {# Guest Access Section - only for private workflows #}
        {% if not workflow.is_public %}
          <div class="card app-card mb-3" id="guest-access-section">
            <div class="card-header">
              <div class="card-title">
                {% trans "Guest Access" %}
                <span class="badge text-bg-secondary ms-2">{{ access_grants|length }}</span>
              </div>
            </div>
            <div class="card-body">
              {% if access_grants %}
                <p class="text-muted small mb-3">
                  {% trans "People with access to this workflow:" %}
                </p>
                <div class="list-group">
                  {% for grant in access_grants %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                      <div>
                        <span class="fw-medium">
                          {{ grant.user.email }}
                        </span>
                        {% if grant.user.name %}
                          <span class="text-muted small ms-2">({{ grant.user.name }})</span>
                        {% endif %}
                        <br />
                        <small class="text-muted">
                          {% trans "Added" %} {{ grant.created|date:"M j, Y" }}
                          {% if grant.granted_by %}
                            {% blocktrans with name=grant.granted_by.name|default:grant.granted_by.email %}by {{ name }}{% endblocktrans %}
                          {% endif %}
                        </small>
                      </div>
                      {% if can_manage_sharing %}
                        <button type="button"
                                class="btn btn-outline-danger btn-sm"
                                disabled
                                title="{% trans 'Coming soon' %}">
                          <i class="bi-x-lg"></i> {% trans "Remove" %}
                        </button>
                      {% endif %}
                    </div>
                  {% endfor %}
                </div>
              {% else %}
                <p class="text-muted mb-0">
                  {% trans "No guests have been granted access to this workflow yet." %}
                </p>
              {% endif %}

              {# Pending Invitations #}
              {% if pending_invites %}
                <hr />
                <p class="text-muted small mb-3">
                  {% trans "Pending invitations:" %}
                  <span class="badge text-bg-warning">{{ pending_invites|length }}</span>
                </p>
                <div class="list-group">
                  {% for invite in pending_invites %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                      <div>
                        <span class="fw-medium">
                          {{ invite.invitee_email|default:invite.invitee_user.email }}
                        </span>
                        <br />
                        <small class="text-muted">
                          {% trans "Invited" %} {{ invite.created|date:"M j, Y" }}
                          {% if invite.expires_at %}
                            路 {% trans "Expires" %} {{ invite.expires_at|date:"M j, Y" }}
                          {% endif %}
                        </small>
                      </div>
                      <span class="badge text-bg-warning">{% trans "Pending" %}</span>
                    </div>
                  {% endfor %}
                </div>
              {% endif %}

              {% if can_manage_sharing %}
                <div class="mt-3">
                  <button type="button"
                          class="btn btn-primary btn-sm"
                          disabled
                          title="{% trans 'Coming in Phase 3' %}">
                    <i class="bi-person-plus me-1"></i>{% trans "Invite Guest" %}
                  </button>
                  <small class="text-muted d-block mt-2">
                    {% trans "Guest invitation functionality coming soon." %}
                  </small>
                </div>
              {% endif %}
            </div>
          </div>
        {% else %}
          <div class="card app-card mb-3">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <i class="bi-globe text-primary fs-3 me-3"></i>
                <div>
                  <p class="mb-0 fw-medium">{% trans "This workflow is public" %}</p>
                  <p class="text-muted small mb-0">
                    {% trans "Any authenticated user can launch this workflow. Guest access management is not needed for public workflows." %}
                  </p>
                </div>
              </div>
            </div>
          </div>
        {% endif %}
      </div>

      <div class="col-12 col-lg-4">
        <div class="card app-card">
          <div class="card-header">
            <div class="card-title">{% trans "About Sharing" %}</div>
          </div>
          <div class="card-body">
            <dl class="mb-0">
              <dt><i class="bi-lock me-1"></i> {% trans "Private" %}</dt>
              <dd class="text-muted small mb-3">
                {% trans "Only org members and invited guests can launch this workflow." %}
              </dd>
              <dt><i class="bi-globe me-1"></i> {% trans "Public" %}</dt>
              <dd class="text-muted small mb-0">
                {% trans "Any logged-in user can launch this workflow. Usage is billed to your organization." %}
              </dd>
            </dl>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock app_content %}
